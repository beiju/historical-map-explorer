<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The de'Barbari Map</title>
    <style type="text/css"> v\:* {behavior:url(#default#VML);}
        html, body { overflow: hidden; padding: 0; height: 100%; width: 100%; font-family: 'Lucida Grande',Geneva,Arial,Verdana,sans-serif; }
        body { margin: 10px; background: white; }
        .nonbold-header-text { margin: 0; padding: 6px; border:0; }
        .header-text { margin: 0; padding: 6px; border:0; font-size: 20pt; }
        #header { height: 176px; padding: 0; background-color: #eee; border: 1px solid #888; }
        #subheader { height: 12px; text-align: right; font-size: 10px; color: #555;}
        #map { height: 95%; border: 1px solid #888; }
    </style>
    <script src="http://www.openlayers.org/api/2.7/OpenLayers.js" type="text/javascript"></script>
    <script type="text/javascript">
    var map;
    var mapBounds = new OpenLayers.Bounds( 0.0, -23297.0, 45947.0, 0.0);
    var mapMinZoom = 0
    var mapMaxZoom = 8;

    // avoid pink tiles
    OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
    OpenLayers.Util.onImageLoadErrorColor = "transparent";

    function init(){
      var options = {
        controls: [],
        maxExtent: new OpenLayers.Bounds(  0.0, -23297.0, 45947.0, 0.0 ),
        maxResolution: 256.000000,
        numZoomLevels: 9
      };
      map = new OpenLayers.Map('map', options);

      var layer = new OpenLayers.Layer.TMS( "TMS Layer", "", {
        url: '', 
        serviceVersion: '.', 
        layername: '.', 
        alpha: true,
        type: 'png', 
        etURL: overlay_getTileURL
      });
      map.addLayer(layer);
      map.zoomToExtent( mapBounds );	
      map.addControl(new OpenLayers.Control.PanZoomBar());
      map.addControl(new OpenLayers.Control.MousePosition());
      map.addControl(new OpenLayers.Control.MouseDefaults());
      map.addControl(new OpenLayers.Control.KeyboardDefaults());
    }
  
    function overlay_getTileURL(bounds) {
      var res = this.map.getResolution();
      var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
      var y = Math.round((bounds.bottom - this.maxExtent.bottom) / (res * this.tileSize.h));
      var z = this.map.getZoom();
      if (x >= 0 && y >= 0) {
        return this.url + z + "/" + x + "/" + y + "." + this.type;				
      } else {
        return "http://www.maptiler.org/img/none.png";
      }
    }
  
    function getWindowHeight() {
      if (self.innerHeight) 
        return self.innerHeight;
      if (document.documentElement && document.documentElement.clientHeight)
        return document.documentElement.clientHeight;
      if (document.body) return document.body.clientHeight;
        return 0;
    }

    function getWindowWidth() {
      if (self.innerWidth) 
        return self.innerWidth;
      if (document.documentElement && document.documentElement.clientWidth)
        return document.documentElement.clientWidth;
      if (document.body) return document.body.clientWidth;
        return 0;
    }

    function resize() {  
      var map = document.getElementById("map");  
      var header = document.getElementById("header");  
      var subheader = document.getElementById("subheader");  
      map.style.height = (getWindowHeight()-200) + "px";
      map.style.width = (getWindowWidth()-20) + "px";
      header.style.width = (getWindowWidth()-20) + "px";
      if (map.updateSize) { map.updateSize(); };
    } 

    onresize=resize;
    </script>
  </head>
  <body onload="init()">
  <div id="header">
    <p class="header-text"><b>The de'Barbari Map</b></p>
    <p class="nonbold-header-text">This map of Venice was created by Jacopo de'Barbari in the year 1500. For more details, refer to the map's <a href="http://www.venipedia.org/wiki/index.php?title=User:Justin/deBarbari">Venipedia entry</a>. This tool allows you the explore the Venice Project Center's extremely high quality scan. You can download what is currently being viewed using the following link:</p>
    <p class="nonbold-header-text"><a id="dl" download="debarbari.png" href="#"><img src="filesave.png" style="vertical-align:middle;">Download current view</a>
  </div>
  <script>
    function getData() {
      var TMSLayer = document.getElementById("OpenLayers.Layer.TMS_4");

      var c = document.createElement("canvas");
      c.width = TMSLayer.parentNode.parentNode.offsetWidth;
      c.height = TMSLayer.parentNode.parentNode.offsetHeight;
      var canvas = c.getContext("2d");

      var img_divs = TMSLayer.children;

      for (i in img_divs) {
        if (isNaN(i)) continue;
        var img = img_divs[i].children[0];
        var rect = img.getBoundingClientRect();

        canvas.drawImage(img, rect.left, rect.top);
      }

      return img_url = c.toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
    }
    
    document.getElementById("dl").onclick = function () { this.href = getData(); setTimeout(function() { document.getElementById("dl").href = "#"; }, 100); };
  </script>
  <div id="map"></div>
  <script type="text/javascript">resize()</script>
  </body>
<!--Tiles generated by MapTiler/GDAL2Tiles, Copyright © 2008 Klokan Petr Pridal, GDAL & OSGeo GSoC-->
</html>
