var map;
var fb = new Firebase('https://debarbari.firebaseio.com/');

var churches_ = [
  {
    name: "Church of San Nicolò dei Mendicoli",
    center: [-72.63993,22875.55664],
    zoom: 7
  },
  {
    name: "Church of San Giacomo dell'Orio",
    center: [-67.11875,22924.90723],
    zoom: 7
  },
  {
    name: "Church of Sant'Alvise",
    center: [-62.69431,22940.04639],
    zoom: 7
  },
  {
    name: "Church of Santo Stefano",
    center: [-74.13408,22916.67847],
    zoom: 6
  },
  {
    name: "Church of Santa Maria Gloriosa dei Frari",
    center: [-69.51915,22913.10791],
    zoom: 6
  },
  {
    name: "Church of the Carmini",
    center: [-72.73148,22894.9585],
    zoom: 7
  },
  {
    name: "Church of San Giobbe",
    center: [-62.84512,22906.74683],
    zoom: 7
  },
  {
    name: "Church of Angelo Raffaele",
    center: [-72.90026,22884.79614],
    zoom: 7
  },
  {
    name: "Church of San Pantalon",
    center: [-70.54686,22904.24194],
    zoom: 7
  },
  {
    name: "Church of San Giacomo at Rialto",
    center: [-69.75616,22947.4292],
    zoom: 7
  },
  {
    name: "Church of Santi Maria e Donato",
    center: [-61.90793,23002.37183],
    zoom: 7
  },
  {
    name: "Church of Madonna dell'Orto",
    center: [-63.77278,22946.90186],
    zoom: 7
  },
  {
    name: "Church of S. Michele in Isola",
    center: [-64.97936,22987.13379],
    zoom: 7
  },
  {
    name: "Church of Santa Maria dei Miracoli",
    center: [-70.24832,22967.89673],
    zoom: 7
  },
  {
    name: "Church of Santi Apostoli",
    center: [-68.39109,22958.33862],
    zoom: 7
  },
  {
    name: "Church of SS. Giovanni e Paolo",
    center: [-70.71447,22981.97021],
    zoom: 6
  },
  {
    name: "Church of Santa Maria Formosa",
    center: [-73.6154,22976.09253],
    zoom: 7
  },
  {
    name: "Church of San Giovanni Crisostomo",
    center: [-69.72191,22959.77783],
    zoom: 7
  },
  {
    name: "Former Convent of San Salvador",
    center: [-72.7119,22953.41675],
    zoom: 7
  },
  {
    name: "Convent of San Francesco della Vigna",
    center: [-72.47528,23009.63379],
    zoom: 6
  },
  {
    name: "Church of San Lorenzo",
    center: [-74.13408,22998.27393],
    zoom: 6
  },
  {
    name: "Church of Sant'Agnese",
    center: [-76.16925,22889.68506],
    zoom: 7
  },
  {
    name: "Former Church of San Gregorio",
    center: [-77.71627,22914.93164],
    zoom: 6
  },
  {
    name: "Former Church of the Carità",
    center: [-74.48466,22899.6936],
    zoom: 7
  },
  {
    name: "Church of the San Fantin", /* Correct? */
    center: [-75.79403,22932.58667],
    zoom: 7
  },
  {
    name: "Church of San Giovanni in Bragora",
    center: [-76.94545,23009.74365],
    zoom: 6
  },
  {
    name: "Church of San Zaccaria",
    center: [-76.52706,22992.49512],
    zoom: 6
  },
  {
    name: "Church of San Martino near Arsenale",
    center: [-77.57523,23024.23462],
    zoom: 7
  },
  {
    name: "Church of San Giorgio Maggiore and Cloister of the Cipressi",
    center: [-81.43359,22974.36768],
    zoom: 6
  },
  {
    name: "Basilica of Saint Mark",
    center: [-76.05321,22967.18262],
    zoom: 7
  },
  {
    name: "Church of San Pietro di Castello",
    center: [-76.58836,23070.73975],
    zoom: 6
  }
];

var churches = [
  ["Church of San Nicolò dei Mendicoli", [-72.63993, 22875.55664], 7],
  ["Church of San Giacomo dell'Orio", [-67.11875, 22924.90723], 7],
  ["Church of Sant'Alvise", [-62.69431, 22940.04639], 7],
  ["Church of Santo Stefano", [-74.13408, 22916.67847], 6],
  ["Church of Santa Maria Gloriosa dei Frari", [-69.51915, 22913.10791], 6],
  ["Church of the Carmini", [-72.73148, 22894.9585], 7],
  ["Church of San Giobbe", [-62.84512, 22906.74683], 7],
  ["Church of Angelo Raffaele", [-72.90026, 22884.79614], 7],
  ["Church of San Pantalon", [-70.54686, 22904.24194], 7],
  ["Church of San Giacomo at Rialto", [-69.75616, 22947.4292], 7],
  ["Church of Santi Maria e Donato", [-61.90793, 23002.37183], 7],
  ["Church of Madonna dell'Orto", [-63.77278, 22946.90186], 7],
  ["Church of S. Michele in Isola", [-64.97936, 22987.13379], 7],
  ["Church of Santa Maria dei Miracoli", [-70.24832, 22967.89673], 7],
  ["Church of Santi Apostoli", [-68.39109, 22958.33862], 7],
  ["Church of SS. Giovanni e Paolo", [-70.71447, 22981.97021], 6],
  ["Church of Santa Maria Formosa", [-73.6154, 22976.09253], 7],
  ["Church of San Giovanni Crisostomo", [-69.72191, 22959.77783], 7],
  ["Former Convent of San Salvador", [-72.7119, 22953.41675], 7],
  ["Convent of San Francesco della Vigna", [-72.47528, 23009.63379], 6],
  ["Church of San Lorenzo", [-74.13408, 22998.27393], 6],
  ["Church of Sant'Agnese", [-76.16925, 22889.68506], 7],
  ["Former Church of San Gregorio", [-77.71627, 22914.93164], 6],
  ["Former Church of the Carità", [-74.48466, 22899.6936], 7],
  ["Church of the San Fantin", [-75.79403, 22932.58667], 7], /* Correct? */
  ["Church of San Giovanni in Bragora", [-76.94545, 23009.74365], 6],
  ["Church of San Zaccaria", [-76.52706, 22992.49512], 6],
  ["Church of San Martino near Arsenale", [-77.57523, 23024.23462], 7],
  ["Church of San Giorgio Maggiore and Cloister of the Cipressi", [-81.43359, 22974.36768], 6],
  ["Basilica of Saint Mark", [-76.05321, 22967.18262], 7],
  ["Church of San Pietro di Castello", [-76.58836, 23070.73975], 6]
];

var demolishedChurches = [
  ["Demolished Church of Corpus Domini", [-69.1018992122562, 22891.31103515625], 7],
  ["Demolished Church of Santa Lucia", [-67.92720481451185, 22896.23291015625], 7],
  ["Demolished Church of Santa Margherita", [-71.42280436921011, 22901.429443359375], 8],
  ["Demolished Church of the Templari", [-76.75802477369372, 22946.11083984375], 8], // or Santa Maria dell'Ascensione
  ["Demolished Church of Ternita", [-74.5506480395836, 23015.04455566406], 8],
  ["Demolished Church of San Stin", [-68.9869706187376, 22916.689453125], 8],
  ["Demolished Church of Sant'Agostin", [-68.9001312167013, 22926.104736328125], 8],
  ["Demolished Church of San Boldo", [-68.2256180821868, 22932.328491210938], 8],
  ["Demolished Convent of the Celestia", [-73.64481249034911, 23018.5107421875], 8], // or Santa Maria de la Celestia
  ["Demolished Church of Santa Maria dei Servi", [-64.33752904242549, 22934.954223632812], 8], // not really demolished?
  ["Demolished Church of San Tomà", [-71.47610617440442, 22912.66845703125], 8], // not really demolished?
  ["Demolished Church of Santa Croce", [-70.31133703000764, 22891.744995117188], 8],
  ["Demolished Church of San Vio", [-76.34930387697642, 22898.501586914062], 8],
  ["Demolished Convent of the Crociferi", [-67.02887556543278, 22971.69799804687], 8],
  ["Demolished Church of Geminiano", [-76.23475200291313, 22949.21997070312], 8],
  ["Demolished Convent of San Cristoforo", [-66.46724418515859, 22983.11279296875], 8],
  ["Demolished Church of San Provolo", [-76.05188901233623, 22985.101318359375], 8],
  ["Demolished Church of Santa Marina", [-71.07049277109596, 22967.77587890625], 8],
  ["Demolished Church of San Daniele", [-76.74165712324191, 23057.237548828125], 8],
  ["Demolished Convent of the Vergini", [-77.33662698794667, 23025.855102539062], 8], //??
  ["Demolished Church of San Paterniano", [-73.67417651166814, 22938.788452148438], 8],
  ["Demolished Church of San Severo", [-75.3617294907569, 22987.996215820312], 8],
  ["Demolished Church of Sant'Angelo", [-73.9194260357383, 22921.226806640625], 8],
  ["Demolished Church of San Nicoló di Castello", [-78.64299357031803, 23054.326171875], 7], //?
  ["Demolished Convent of Sant'Anna", [-78.510263861155, 23072.266845703125], 8],
  ["Demolished Hospital and Convent of Sant’Antonio", [-80.297927149974, 23067.059326171875], 8],
  ["Demolished Convent of San Domenico", [-78.94087000996285, 23058.599853515625], 8],
  ["Demolished Church of San Bartolomeo di Castello", [-71.18952520749146, 22957.613525390625], 8] //?
  /*["Convent of the Crociferi????????", [-67.08668927672144, 22971.533203125], 7]*/
];

var repurposedChurches = [
  ["Church of San Vidal", [-74.48760078108175, 22912.6904296875], 7]
];

var bridges = [
  ["Ponte de la Croze", [-82.85133180485437, 22913.27270507812], 7]
];

var demolishedChurchColors = [
  [ "Demolished Church of Corpus Domini",
    [-69.9830151028733, 22888.883056640625],
    [-69.51145744782765, 22891.607666015625],
    [-69.36483123672544, 22891.541748046875],
    [-69.26393034602106, 22892.113037109375],
    [-69.18599349954394, 22892.069091796875],
    [-69.22499685411589, 22892.178955078125],
    [-69.18599349954394, 22892.552490234375],
    [-68.88727366584355, 22892.530517578125],
    [-68.60852084639887, 22890.882568359375],
    [-68.6325507815757, 22890.640869140625],
    [-68.52823492039876, 22890.61889648437],
    [-68.47186403726953, 22890.37719726562],
    [-68.52823492039876, 22890.113525390625],
    [-68.51214331858071, 22890.003662109375],
    [-68.5443150407769, 22888.619384765625],
    [-68.65655498475735, 22888.201904296875],
    [-69.58056349224897, 22887.301025390625],
    [-69.52683366454718, 22887.608642578125],
    [-69.55755297124296, 22887.85034179687]
  ],
  [ "Demolished Church of Santa Lucia",
    [-68.48395536734631, 22896.046142578125],
    [-68.53225602660771, 22896.199951171875],
    [-68.27345405495296, 22897.36450195312],
    [-68.05278304131106, 22897.342529296875],
    [-68.10200447389143, 22897.474365234375],
    [-67.92926896758328, 22898.11157226562],
    [-67.59666247714624, 22898.089599609375],
    [-67.29325646952465, 22896.199951171875],
    [-67.29325646952465, 22895.84838867187],
    [-67.62177205521934, 22894.354248046875],
    [-67.6969406930543, 22894.83764648437],
    [-67.67191113958987, 22894.947509765625],
    [-67.80509469602548, 22896.024169921875]
  ],
  [ "Demolished Church of San Stin",
    [-69.32995725081676, 22915.17333984375],
    [-69.20550391636527, 22915.1513671875],
    [-69.15864952562399, 22915.2392578125],
    [-69.08817875992878, 22915.2392578125],
    [-69.01748042199839, 22915.283203125],
    [-69.0332108625924, 22915.634765625],
    [-69.00173871231313, 22915.72265625],
    [-68.63655326841952, 22915.74462890625],
    [-68.40322416624196, 22915.986328125],
    [-68.62854757995426, 22916.25],
    [-68.96233509064633, 22916.31591796875],
    [-68.97022145813169, 22917.6123046875],
    [-69.00961097622238, 22917.744140625],
    [-69.0646379640348, 22917.72216796875],
    [-69.10385857475971, 22917.81005859375],
    [-69.26004013759507, 22917.81005859375],
    [-69.3609591299117, 22917.5244140625]
  ],
  [ "Demolished Church of San Tomà",
    [-71.5978807327708, 22913.300170898438],
    [-71.55274065141298, 22912.827758789062],
    [-71.43417616304582, 22912.827758789062],
    [-71.3816348737918, 22913.069458007812],
    [-71.37110941823616, 22913.179321289062],
    [-71.3675996578466, 22913.541870117188],
    [-71.38864865717821, 22913.783569335938],
    [-71.38864865717821, 22913.607788085934],
    [-71.44816299792794, 22913.464965820312]
  ],
  [ "Demolished Church of Geminiano",
    [-76.44490733708943, 22949.208984375],
    [-76.53729617099738, 22949.27490234375],
    [-76.53729617099738, 22949.7802734375],
    [-76.25825951133778, 22949.736328125],
    [-76.1902412856612, 22949.472656249996],
    [-76.19548515714274, 22949.296874999996],
    [-76.06380082579659, 22949.27490234375],
    [-75.82903976426945, 22948.83544921875],
    [-76.06380082579659, 22948.505859375],
    [-76.33633385775283, 22948.505859375],
    [-76.33114246585924, 22947.4951171875],
    [-76.39331166244494, 22947.5390625],
    [-76.37261948220726, 22948.286132812496],
    [-76.42944882508331, 22948.330078125],
    [-76.39847988900951, 22948.61572265625]
  ],
  [ "Demolished Convent of the Celestia",
    [-73.86761239709705, 23017.9833984375],
    [-73.9194260357383, 23019.42260742187],
    [-73.53462847039683, 23019.400634765625],
    [-73.43468937493594, 23019.27978515625],
    [-73.43468937493594, 23019.114990234375],
    [-73.52216821373521, 23018.88427734375],
    [-73.58748242628445, 23018.88427734375],
    [-73.42215560370377, 23016.917724609375],
    [-73.46285669225547, 23016.719970703125],
    [-73.53462847039683, 23016.730957031246],
    [-73.5595215050371, 23017.093505859375],
    [-73.6060973425433, 23017.17041015625],
    [-73.67108797869977, 23017.17041015625],
    [-73.7972528526321, 23017.137451171875],
    [-73.81257376708518, 23017.56591796875]
  ],
  [ "Demolished Church of San Vio",
    [-76.65444953503201, 22899.034423828125],
    [-76.66965642801192, 22898.84765625],
    [-76.56284986632163, 22898.814697265625],
    [-76.437180242191, 22898.309326171875],
    [-76.26086902512846, 22898.34228515625],
    [-76.22167523997352, 22898.82568359375],
    [-76.19548515714274, 22899.0673828125],
    [-76.20596704314148, 22899.3310546875],
    [-76.41397301513197, 22899.935302734375],
    [-76.49631101453926, 22900.242919921875],
    [-76.52194106477647, 22900.330810546875],
    [-76.49631101453926, 22900.001220703125],
    [-76.56540261576497, 22899.045410156246]
  ],
  [ "Demolished Church of San Daniele",
    [-77.29320180280092, 23057.7099609375],
    [-77.15227758214056, 23057.68798828125],
    [-77.03941844273027, 23057.5341796875],
    [-77.05419428289702, 23058.25927734375],
    [-76.8358132457717, 23058.3251953125],
    [-76.75047294087425, 23058.10546875],
    [-76.70507304221529, 23057.556152343746],
    [-76.61381450204216, 23057.556152343746],
    [-76.45005633358495, 23057.2705078125],
    [-76.58325853729983, 23056.94091796875],
    [-76.68484630658422, 23056.875],
    [-76.64430214504891, 23055.6884765625],
    [-76.6239846338914, 23055.66650390625],
    [-76.57305800816077, 23054.282226562496],
    [-76.55263410642529, 23053.7548828125],
    [-76.6087265897133, 23053.95263671875],
    [-76.83080820849284, 23054.4580078125],
    [-76.90070892588689, 23054.677734375],
    [-77.00981701794444, 23055.205078124996],
    [-77.0836963067392, 23055.5126953125],
    [-77.23021785516423, 23056.040039062496]
  ],
  [ "Demolished Church of San Bartolomeo di Castello",
    [-71.95858391176317, 22958.822021484375],
    [-71.97218900592375, 22959.019775390625],
    [-71.81512993041657, 22959.56909179687],
    [-71.71888229713917, 22959.56909179687],
    [-71.6774828543785, 22959.393310546875],
    [-71.6774828543785, 22959.23950195312],
    [-71.65674919588636, 22959.173583984375],
    [-71.57358780072138, 22959.129638671875],
    [-71.53882990638355, 22958.997802734375],
    [-71.46912418989676, 22957.701416015625],
    [-71.10965785497814, 22957.72338867187],
    [-70.79413934642663, 22957.459716796875],
    [-71.09542504766098, 22957.152099609375],
    [-71.43417616304582, 22957.152099609375],
    [-71.51097803770108, 22957.020263671875],
    [-71.57358780072138, 22956.998291015625],
    [-71.65674919588636, 22956.734619140625],
    [-71.7050925307212, 22956.690673828125],
    [-71.7739410364347, 22957.767333984375],
    [-71.76019138754775, 22957.943115234375],
    [-71.74643171904148, 22958.470458984375],
    [-71.76019138754775, 22958.865966796875]
  ],
  [ "Demolished Convent of San Cristoforo",
    [-66.77458576472547, 22982.27783203125],
    [-66.32868478255794, 22982.27783203125],
    [-66.22260000154931, 22982.45361328125],
    [-66.25801126452266, 22983.99169921875],
    [-66.33750501996518, 22984.12353515625],
    [-66.40795547978848, 22984.69482421875],
    [-66.81787214936936, 22984.716796875],
    [-66.81787214936936, 22984.29931640625],
    [-66.76591933032796, 22984.12353515625],
    [-66.80922097449334, 22983.8818359375],
    [-66.85244636494531, 22983.7939453125],
    [-66.85244636494531, 22983.42041015625],
    [-66.80922097449334, 22982.76123046875]
  ],
  [ "Demolished Church of Ternita",
    [-74.65129477919845, 23013.292236328125],
    [-74.28653913497898, 23013.292236328125],
    [-74.28653913497898, 23013.44604492187],
    [-74.13107414231926, 23013.577880859375],
    [-74.29248881670038, 23013.775634765625],
    [-74.31626559042309, 23013.885498046875],
    [-74.58134763420868, 23013.929443359375],
    [-74.5755046849982, 23014.083251953125],
    [-74.4405190775907, 23014.127197265625],
    [-74.36963510892254, 23014.259033203125],
    [-74.62801354073919, 23017.005615234375],
    [-74.66292249033842, 23017.137451171875],
    [-74.89367903011835, 23017.247314453125],
    [-74.97933566982907, 23016.829833984375],
    [-74.86502093158697, 23015.137939453125],
    [-74.801786094667, 23014.500732421875],
    [-74.81905749995477, 23014.017333984375],
    [-74.76718570583333, 23013.929443359375],
    [-74.71514088066166, 23013.709716796875],
    [-74.71514088066166, 23013.44604492187],
  ],
  [ "Demolished Church of San Boldo",
    [-68.67653884786664, 22932.13623046875],
    [-68.4597662352406, 22931.21337890625],
    [-68.26531882965097, 22931.25732421875],
    [-68.19197126323203, 22931.65283203125],
    [-67.81339357926149, 22931.69677734375],
    [-67.61340516352136, 22931.8505859375],
    [-67.78848808681396, 22932.0703125],
    [-68.24903968254743, 22932.09228515625],
    [-68.23274893432084, 22932.377929687496],
    [-68.28158638257969, 22932.70751953125],
    [-68.31408673369978, 22932.94921875],
    [-68.50006707835483, 22933.037109375]
  ],
  [ "Demolished Church of Santa Margherita",
    [-71.66366293141732, 22900.89660644531],
    [-71.1487448581535, 22900.89660644531],
    [-70.9489419291186, 22901.083374023438],
    [-71.11677038645315, 22901.270141601562],
    [-71.3219146980122, 22901.31408691406],
    [-71.26553875788552, 22901.467895507812],
    [-71.30783606806223, 22901.676635742188],
    [-71.30431481203014, 22901.742553710938],
    [-71.33246695946693, 22901.81945800781],
    [-71.32895017791996, 22901.896362304688],
    [-71.40617196718854, 22902.127075195312],
    [-71.45515260247821, 22902.160034179684],
    [-71.56664127895979, 22902.500610351562],
    [-71.60828252210263, 22902.368774414062],
    [-71.63253129384887, 22902.434692382812],
    [-71.75331280615367, 22902.138061523438],
    [-71.72232816987228, 22902.116088867188],
    [-71.73266202440854, 22901.929321289062],
    [-71.72577341526036, 22901.852416992188],
    [-71.72921803340522, 22901.665649414062],
    [-71.83226541396861, 22901.336059570312]
  ],
  [ "Demolished Church of the Templari",
    [-76.41397301513197, 22946.204223632812],
    [-76.59090394154062, 22946.555786132812],
    [-76.64937678661772, 22946.577758789062],
    [-76.65444953503201, 22946.841430664062],
    [-76.8258013019347, 22946.86340332031],
    [-76.90817663339621, 22946.764526367188],
    [-76.84831766520081, 22946.698608398438],
    [-76.99746348901586, 22946.654663085938],
    [-77.03202430789142, 22946.599731445312],
    [-76.8258013019347, 22946.533813476562],
    [-76.80073870685206, 22946.390991210938],
    [-76.80073870685206, 22945.127563476562],
    [-76.91564015798626, 22944.743041992188],
    [-76.87578632907257, 22944.699096679688],
    [-76.84081641443098, 22944.237670898438],
    [-76.8207925254374, 22943.897094726562],
    [-76.76808730847439, 22943.578491210934],
    [-76.72779205535174, 22943.512573242188],
    [-76.66712312789022, 22943.941040039062],
    [-76.67472161047135, 22944.380493164062],
    [-76.61381450204216, 22944.490356445312],
    [-76.62144281232145, 22945.962524414062],
    [-76.59854506890697, 22945.962524414062]
  ],
  [ "Demolished Church of Sant'Agostin",
    [-69.26781985689236, 22925.363159179688],
    [-69.39578308847753, 22925.736694335938],
    [-69.37644338897056, 22927.362670898438],
    [-69.15864952562399, 22927.351684570312],
    [-69.08817875992878, 22927.208862304688],
    [-69.01354605132325, 22927.186889648438],
    [-68.94655388492086, 22927.066040039062],
    [-68.93076137911453, 22926.835327148438],
    [-68.9347105653255, 22925.81359863281],
    [-68.58446515587406, 22925.802612304688],
    [-68.37085098819868, 22925.571899414062],
    [-68.57242764505652, 22925.319213867188],
    [-69.0489300409776, 22925.30822753906],
    [-69.11561106499447, 22925.297241210938],
    [-69.12735724054713, 22925.363159179688]
  ],
  [ "Demolished Church of Santa Maria dei Servi",
    [-64.37794095121995, 22933.67431640625],
    [-64.03374392176401, 22933.707275390625],
    [-63.89389686445524, 22933.970947265625],
    [-64.08660677881706, 22935.7177734375],
    [-63.908396220031165, 22935.816650390625],
    [-63.85035383590237, 22936.08032226562],
    [-63.90356393373293, 22936.333007812496],
    [-64.01449619484471, 22936.420898437496],
    [-64.12019460255497, 22936.44287109375],
    [-64.20637724320851, 22936.53076171875],
    [-64.33039136366136, 22936.70654296875],
    [-64.4917250443547, 22936.7724609375],
    [-64.59561280029604, 22936.717529296875],
    [-64.70849431189004, 22936.234130859375],
    [-64.82558083705078, 22936.22314453125],
    [-64.69910544204765, 22935.135498046875],
    [-64.52482316878353, 22935.135498046875]
  ],
  [ "Demolished Church of Santa Croce",
    [-69.8944535563049, 22892.338256835938],
    [-69.94725875962982, 22892.590942382812],
    [-70.46804404880442, 22892.634887695312],
    [-70.56697579857062, 22891.690063476562],
    [-70.6144376304049, 22891.635131835934],
    [-70.66542571668693, 22891.624145507812],
    [-70.75253391771874, 22890.921020507812],
    [-70.73441756577733, 22890.635375976562],
    [-70.75253391771874, 22890.569458007812],
    [-70.77063387910007, 22890.481567382812],
    [-70.85368295996871, 22890.45959472656],
    [-70.87889017463034, 22890.261840820312],
    [-70.54137317584751, 22890.294799804688],
    [-70.51573813075655, 22890.503540039062],
    [-70.46069654685324, 22890.558471679688],
    [-70.22045210190214, 22892.085571289062],
    [-69.92841504053843, 22892.107543945312]
  ],
  [ "Demolished Convent of the Crociferi",
    [-68.0178542446896, 22971.1376953125],
    [-67.81961580805478, 22970.10498046875],
    [-67.85691439687173, 22969.962158203125],
    [-67.71986105811756, 22969.1162109375],
    [-67.75731889478396, 22969.072265625],
    [-67.69485591428801, 22968.5009765625],
    [-67.43912125718222, 22968.621826171875],
    [-67.40959748761922, 22968.47900390625],
    [-67.29537681739308, 22968.52294921875],
    [-67.21892604751504, 22968.731689453125],
    [-67.137963647964, 22968.720703125],
    [-67.08241150454835, 22968.973388671875],
    [-67.09524255478588, 22969.08325195312],
    [-67.06957365415043, 22969.127197265625],
    [-66.77675189615616, 22970.467529296875],
    [-66.47601573761263, 22970.54443359375],
    [-66.34852596083981, 22970.841064453125],
    [-66.33530025104687, 22970.939941406246],
    [-66.65080036855949, 22973.192138671875],
    [-66.51982726125505, 22973.214111328125],
    [-66.50669189246187, 22973.565673828125],
    [-66.59849407838178, 22973.895263671875],
    [-66.91929528033273, 22973.873291015625],
    [-66.96662569006368, 22974.005126953125],
    [-67.25293421221419, 22974.005126953125],
    [-67.09524255478588, 22974.64233398437],
    [-67.29537681739308, 22974.64233398437]
  ],
  [ "Demolished Church of San Provolo",
    [-75.83979428058724, 22985.277099609375],
    [-75.91485234607738, 22985.013427734375],
    [-76.01874825620261, 22984.95849609375],
    [-76.33892882834351, 22984.859619140625],
    [-76.49374538019939, 22985.013427734375],
    [-76.49117926746597, 22986.024169921875],
    [-76.19286346551333, 22985.68359375],
    [-76.18237181591432, 22985.419921874996],
    [-75.94690063571745, 22985.49682617187]
  ],
  [ "Demolished Church of Santa Marina",
    [-71.49703690095419, 22968.28125],
    [-71.33246695946693, 22968.325195312496],
    [-71.3500412872444, 22968.270263671875],
    [-71.26906705543637, 22968.25927734375],
    [-71.24435551310671, 22968.226318359375],
    [-71.20191973293133, 22967.819824218746],
    [-70.9202326894952, 22967.8857421875],
    [-70.91304887381109, 22967.7978515625],
    [-70.7108417829381, 22967.68798828125],
    [-70.90586245415462, 22967.46826171875],
    [-71.19129633610842, 22967.3583984375],
    [-71.12388033757496, 22966.622314453125],
    [-71.10254274232307, 22966.63330078125],
    [-71.09186523181886, 22966.5673828125],
    [-71.16648590317222, 22966.45751953125],
    [-71.2054595798469, 22966.435546875],
    [-71.20899878425502, 22966.28173828125],
    [-71.25141915909555, 22966.13891601562],
    [-71.29374720578106, 22966.160888671875],
    [-71.34301347171373, 22966.435546875],
    [-71.45165811785856, 22966.76513671875],
    [-71.3816348737918, 22966.85302734375],
    [-71.38864865717821, 22967.07275390625],
    [-71.40967471884784, 22967.46826171875],
    [-71.4586464518894, 22968.006591796875],
    [-71.4795962147164, 22968.1494140625],
    [-71.56664127895979, 22968.16040039062]
  ],
  [ "Demolished Convent of the Vergini",
    [-77.14983442687364, 23026.536254882812],
    [-77.22293074946597, 23026.734008789062],
    [-77.31251993823142, 23026.712036132812],
    [-77.26659212172262, 23025.953979492188],
    [-77.29561815096989, 23025.393676757812],
    [-77.31493267309955, 23025.338745117188],
    [-77.29561815096989, 23024.251098632812],
    [-77.26659212172262, 23024.163208007812],
    [-77.23264598206126, 23023.657836914062],
    [-77.2544787022853, 23023.262329101562],
    [-77.33662698794667, 23023.21838378906],
    [-77.33903521340181, 23023.086547851562],
    [-77.34866361101341, 23022.515258789062],
    [-77.32698957951605, 23022.449340820312],
    [-77.32698957951605, 23022.295532226562],
    [-77.2205008056289, 23022.350463867188],
    [-77.1253777379959, 23021.976928710938],
    [-77.08615182348998, 23021.987915039062],
    [-76.93055466727323, 23021.185913085938],
    [-76.86081041605962, 23021.185913085938],
    [-76.8583127988792, 23021.273803710934],
    [-76.7856786761891, 23021.317749023438],
    [-76.77311575922135, 23021.493530273438],
    [-76.80073870685206, 23021.845092773438],
    [-76.86081041605962, 23021.845092773438],
    [-76.90817663339621, 23022.416381835938],
    [-77.00240628547742, 23022.800903320312],
    [-77.00734723530995, 23022.965698242184],
    [-77.09596930242844, 23023.284301757812],
    [-77.12782546469761, 23023.515014648438],
    [-77.12782546469761, 23023.855590820312],
    [-77.12292955370508, 23024.382934570312],
    [-77.11803181203175, 23024.778442382812],
    [-77.00734723530995, 23024.338989257812],
    [-76.98014914976216, 23025.119018554688],
    [-77.02462602694858, 23025.56945800781],
    [-77.14494674592177, 23025.877075195312]
  ],
  [ "Demolished Church of San Paterniano",
    [-73.81716729139707, 22938.51928710937],
    [-73.52372624705372, 22938.486328125],
    [-73.48317079447644, 22938.771972656246],
    [-73.51437589820816, 22938.958740234375],
    [-73.7773145649156, 22939.07958984375],
    [-73.80797897378112, 22939.013671875]
  ],
  [ "Demolished Church of San Severo",
    [-75.67219739055291, 22987.957763671875],
    [-75.65315356600064, 22986.9580078125],
    [-75.58220216863468, 22986.80419921875],
    [-75.37283104050242, 22986.968994140625],
    [-75.38115179778424, 22987.9248046875],
    [-75.19982799874002, 22987.94677734375],
    [-75.20263418141893, 22988.056640625],
    [-75.0361762907506, 22988.276367187496],
    [-75.20824498631067, 22988.4521484375],
    [-75.2306674128157, 22988.49609375],
    [-75.43374250254331, 22988.507080078125],
    [-75.43374250254331, 22988.60595703125],
    [-75.41162164538234, 22988.572998046875],
    [-75.40885422846453, 22989.26513671875],
    [-75.44202936067158, 22989.276123046875],
    [-75.44479062156887, 22989.759521484375],
    [-75.47513069090051, 22989.92431640625],
    [-75.48890116641715, 22989.66064453125],
    [-75.56304125915767, 22989.66064453125],
    [-75.53562529096111, 22988.61694335937],
    [-75.52189820596192, 22988.56201171875],
    [-75.53562529096111, 22988.47412109375],
    [-75.51640380295773, 22988.419189453125],
    [-75.52464464250062, 22988.03466796875]
  ],
  [ "Demolished Church of Sant'Angelo",
    [-74.31626559042309, 22921.907958984375],
    [-74.31626559042309, 22921.09497070312],
    [-74.17307693616263, 22920.040283203125],
    [-73.9255110961111, 22919.996337890625],
    [-73.8889670782383, 22920.391845703125],
    [-73.83399936212712, 22920.413818359375],
    [-73.77884912665854, 22920.633544921875],
    [-73.7972528526321, 22920.743408203125],
    [-73.387640188699, 22920.743408203125],
    [-73.36249421421914, 22920.84777832031],
    [-73.31209125848112, 22920.803833007812],
    [-73.04503280392986, 22920.979614257812],
    [-73.29630993228643, 22921.254272460938],
    [-73.35620194350967, 22921.287231445312],
    [-73.36249421421914, 22921.342163085938],
    [-73.76656867641162, 22921.44104003906],
    [-73.7880535310551, 22921.605834960934],
    [-73.93767449179174, 22921.660766601562],
    [-73.96197440409625, 22921.869506835938],
    [-74.00138543185918, 22921.891479492188],
    [-74.08896275037885, 22922.254028320312],
    [-74.19702987344509, 22922.221069335938],
    [-74.22094748221836, 22921.913452148438]
  ],
  [ "Demolished Church of San Nicoló di Castello",
    [-78.92505320959486, 23052.782592773438],
    [-78.86792754850678, 23052.804565429688],
    [-78.82542475921761, 23052.617797851562],
    [-78.80197997387756, 23052.431030273438],
    [-78.78703528829747, 23052.365112304688],
    [-78.73564673512664, 23052.365112304688],
    [-78.7163161518392, 23052.870483398438],
    [-78.67324199721936, 23054.243774414062],
    [-78.67108403464245, 23054.430541992188],
    [-78.51901414405965, 23054.44152832031],
    [-78.51463982473128, 23054.518432617188],
    [-78.3582817953939, 23054.683227539062],
    [-78.51901414405965, 23054.979858398438],
    [-78.54740718204249, 23055.012817382812],
    [-78.61700290765789, 23055.03479003906],
    [-78.61266542765814, 23055.287475585934],
    [-78.57137794008985, 23055.671997070312],
    [-78.57137794008985, 23055.946655273438],
    [-78.60181459089996, 23056.100463867188],
    [-78.6840257262667, 23056.441040039062],
    [-78.82968223791016, 23056.506958007812]
  ],
  [ "Demolished Convent of Sant'Anna",
    [-78.84031892938711, 23074.82666015625],
    [-78.64299357031803, 23074.6728515625],
    [-78.60832631669345, 23074.25537109375],
    [-78.51245204851115, 23072.717285156246],
    [-78.42019327591201, 23072.4755859375],
    [-78.264802026314, 23072.40966796875],
    [-78.24691262580767, 23072.2998046875],
    [-78.09829559916763, 23072.10205078125],
    [-78.09829559916763, 23071.97021484375],
    [-78.25138749506708, 23071.83837890625],
    [-78.25138749506708, 23071.66259765625],
    [-78.4157818173868, 23071.75048828125],
    [-78.43341771170695, 23070.38818359375],
    [-78.50369683152965, 23070.2783203125],
    [-78.52994275268289, 23070.2783203125],
    [-78.63000556774836, 23070.25634765625],
    [-78.88700169026613, 23071.9921875],
    [-78.87852828127828, 23073.42041015625],
    [-78.93349161441961, 23073.94775390625],
    [-78.92927320597398, 23074.4091796875],
    [-78.87004849291571, 23074.38720703125],
    [-78.84031892938711, 23074.27734375]
  ],
  [ "Demolished Hospital and Convent of Sant’Antonio",
    [-80.71109268759261, 23063.92822265625],
    [-80.71109268759261, 23065.0048828125],
    [-80.63631593879032, 23065.0048828125],
    [-80.6040864125898, 23065.1806640625],
    [-80.59331882551383, 23065.33447265625],
    [-80.53929719513783, 23065.29052734375],
    [-80.49222985736193, 23065.400390625],
    [-80.4558664026958, 23065.59814453125],
    [-80.4813352579822, 23065.68603515625],
    [-80.44857719410551, 23068.80615234375],
    [-80.38272563960412, 23068.7841796875],
    [-80.30902968174865, 23068.740234375],
    [-80.23850054635392, 23068.740234375],
    [-80.17496478929431, 23068.71826171875],
    [-80.15619999232506, 23068.8720703125],
    [-80.11479244077701, 23062.67578125],
    [-80.12610248167238, 23062.30224609375],
    [-80.4083878514756, 23062.21435546875]
  ],
  [ "Demolished Convent of San Domenico",
    [-78.83393811511223, 23056.8310546875],
    [-78.83819239140279, 23057.38037109375],
    [-78.52338681973251, 23057.3583984375],
    [-78.510263861155, 23057.5341796875],
    [-78.29827231818686, 23057.75390625],
    [-78.51901414405965, 23057.99560546875],
    [-78.54522556398216, 23058.061523437496],
    [-78.56266703393182, 23058.08349609375],
    [-78.83393811511223, 23058.12744140625],
    [-78.84244506736057, 23059.3798828125],
    [-78.82116567845546, 23059.40185546875],
    [-78.795577517967, 23059.9951171875],
    [-78.88488393583316, 23060.85205078125],
    [-78.91449626766514, 23060.830078125],
    [-78.91872023639334, 23060.654296875],
    [-78.93560022334694, 23060.63232421875],
    [-79.02798723315072, 23060.654296875],
    [-79.02380440162672, 23060.302734375],
    [-79.05305117823617, 23059.88525390625],
    [-79.12790415625976, 23059.92919921875],
    [-79.12375895511988, 23059.00634765625],
    [-79.04887778502159, 23058.720703125],
    [-79.0405262831424, 23058.61083984375],
    [-79.02380440162672, 23058.5888671875],
    [-79.03216849019778, 23058.30322265625],
    [-79.13204779656223, 23058.28125],
    [-79.13204779656223, 23058.061523437496],
    [-79.08222097300246, 23058.08349609375],
    [-79.01961999505518, 23058.03955078125],
    [-79.01124645448628, 23057.90771484375],
    [-79.00286660687577, 23057.77587890625],
    [-79.01124645448628, 23057.666015625],
    [-79.0405262831424, 23057.60009765625],
    [-79.04887778502159, 23057.51220703125],
    [-79.02380440162672, 23057.38037109375],
    [-79.02798723315072, 23057.0947265625],
    [-79.18577334159917, 23056.94091796875],
    [-79.05305117823617, 23056.5673828125],
    [-78.88488393583316, 23056.58935546875]
  ]
];

var bridgeColors = [
  [ "Ponte de la Croze",
    [-82.89970337643459, 22912.6025390625],
    [-82.87249197680256, 22912.646484375],
    [-82.85064817916859, 22912.80029296875],
    [-82.83422163810538, 22913.10791015625],
    [-82.82873778533543, 22913.41552734375],
    [-82.83970131925237, 22913.701171875],
    [-82.86976513726212, 22913.942871093746],
    [-82.90241882535476, 22914.0087890625],
    [-82.84791302601151, 22914.2724609375],
    [-82.83696199993649, 22914.536132812496],
    [-82.80125583766977, 22914.51416015625],
    [-82.79023374767752, 22913.96484375],
    [-82.78747560323012, 22913.437499999996],
    [-82.79574688944791, 22912.97607421875],
    [-82.80400874018102, 22912.514648437496]
  ]
]

function findData(list, val) {
  for (var i = 0; i < list.length; i++) {
    if (list[i][0] == val) return list[i];
  }

  return null;
}

function findData_(list, val) {
  for (var i = 0; i < list.length; i++) {
    if (list[i].name == val) return list[i];
  }

  return null;
}

function getAutoCompleteNames(datasets) {
  churchNames = []
  for (var i = 0; i < datasets.length; ++i) {
    for (var j = 0; j < datasets[i].length; ++j) {
      churchNames.push(datasets[i][j][0]);
    }
  }

  return churchNames;
}

function debarbariInit() {
  // jQuery init
  $(function() {
    // Register handlers
    $("#header").hover(
      function () { // onmouseenter
        $("#header").animate({ opacity: 1.0 }, 250); 
      },
      function () { // onmouseleave
        $("#header").animate({ opacity: 0.6 }, 250); 
      }
    );

    $(".dl").click(function () { 
      this.href = getData(); 
      setTimeout(function() { 
        $("#dl").attr("href", "#");
      }, 100); 
    });

    rectDrawer = new RectDrawer;
    $("#select").click(rectDrawer.initialize.bind(rectDrawer, downloadSection));

    $("#minus-sign").click(hideHeader);
    $("#plus-sign").click(showHeader);

    $("#churches-layer").click(toggleChurchLayer);
    $("#bridges-layer").click(toggleBridgeLayer);

    $('#drawmode').click(togglePolyMode);

    $('#login-link').click(function () {
      showLoginForm('login');
    });
    $('#signup-link').click(function () {
      showLoginForm('signup');
    })

    function showdrawicon() {
      if(window.location.hash == '#color') {
        $('#drawmode').css('display', 'inline');
      }
      else {
        $('#drawmode').css('display', 'none');
      }
    }
    window.onhashchange = showdrawicon;
    showdrawicon();

    // Initialize search
    var churchNames = getAutoCompleteNames([churches, demolishedChurches, repurposedChurches, bridges]); //churches_.map(function (e) { return e.name; });
    // for (var i = 0; i < demolishedChurches.length; ++i) {
    //   churchNames.push(demolishedChurches[i][0]);
    // }
    // for (var i = 0; i < repurposedChurches.length; ++i) {
    //   churchNames.push(repurposedChurches[i][0]);
    // }
    // for (var i = 0; i < bridges.length; ++i) {
    //   churchNames.push(bridges[i][0]);
    // }
    $(".search").autocomplete({ source: churchNames });
    $(".search").on("autocompleteselect", function (event, ui) {
      var church = findData(churches, ui.item.value) || findData(repurposedChurches, ui.item.value) || findData(demolishedChurches, ui.item.value) || findData(bridges, ui.item.value);
      map.setView(church[1], 8 /* LOL IGNORE ZOOM */, { animate: true });
    });
    
    // Initialize leaflet map
    map = L.map('map', { center: [-73, 22973.5], zoom: 3, attributionControl: false });
    new L.Control.Attribution({ prefix: false }).addAttribution('<a href="http://veniceprojectcenter.org">Venice Project Center</a>').addTo(map);
    L.tileLayer('tiles/{z}/{x}/{y}.png', {minZoom: 2, maxZoom: 8, tms: true}).addTo(map);

    var tms2 = L.tileLayer('tiles2/{z}/{x}/{y}.png', {minZoom: 2, maxZoom: 8, tms: true});
    var miniMap = new L.Control.MiniMap(tms2, { toggleDisplay: true }).addTo(map);
  });
}

function getCanvasFromMap() {
  var c = document.createElement("canvas");
  c.width = $("#map").width();
  c.height = $("#map").height();
  var canvas = c.getContext("2d");

  var imgs = $(".leaflet-tile-container.leaflet-zoom-animated").children();

  for (i in imgs) {
    if (isNaN(i)) continue;
    var img = imgs[i];
    var rect = img.getBoundingClientRect();

    canvas.drawImage(img, rect.left, rect.top);
  }

  return c;
}

function getData() {
  var c = getCanvasFromMap();

  var img_url = c.toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
  return img_url;
}

function hideHeader() {
  $("#header").animate({height: 0, width: 0}, 250, function () {
    $("#header").css('display', 'none');
    $("#mini-header").css('display', 'block');
  });
}

function showHeader() {
  $("#header").css({height: "auto", width: "auto"});
  var autoWidth = $("#header").css("width");
  var autoHeight = $("#header").css("height");
  $("#header").css({height: 0, width: 0, display: "block"});

  $("#mini-header").css({display: "none"});
  $("#header").animate({height: autoHeight, width: autoWidth}, 250);
}

function downloadSection(x, y, width, height) {
  var canvas = getCanvasFromMap();
  var ctx = canvas.getContext('2d');

  var selection = ctx.getImageData(x, y, width, height);
  canvas.width = width;
  canvas.height = height;
  ctx.putImageData(selection, 0, 0);

  var link = document.createElement("a");
  link.href = canvas.toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
  link.download = "debarbari.png";
  var theEvent = document.createEvent("MouseEvent");
  theEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
  link.dispatchEvent(theEvent);
}

function addRect(x, y, width, height) {
  var mapBounds = map.getBounds();

  var mapWidth = (mapBounds.getEast() - mapBounds.getWest()) * (width / window.innerWidth);
  var mapHeight = (mapBounds.getNorth() - mapBounds.getSouth()) * (height / window.innerHeight);

  var mapLng = ((mapBounds.getEast() - mapBounds.getWest()) * (x / window.innerWidth)) + mapBounds.getWest();
  var mapLat = ((mapBounds.getNorth() - mapBounds.getSouth()) * (y / window.innerHeight)) + mapBounds.getSouth();

  var rectBounds = [[mapLat+mapHeight, mapLng], [mapLat, mapLng+mapWidth]];
  new L.rectangle(rectBounds, {fillColor: "#ff7800", weight: 1}).addTo(map);
  console.log(rectBounds.toString());
}

// Draw poly
var points = [];
var markers = [];

var circleIcon = L.icon({
  // lol...
  iconUrl: "http://www.rand.org/content/dam/rand/www/external/pubs/research_briefs/RB9385/images/circle1.gif", 
  iconSize: [12, 12],
  iconAnchor: [6, 6]
});

function addPoint(event) {
  var marker = new L.Marker(event.latlng, {icon: circleIcon});
  marker.addTo(map);
  markers.push(marker);
  points.push(event.latlng);
}

var polymode = false;
function togglePolyMode() {
  if (polymode) {
    endPolyMode();
    polymode = false;
  }
  else {
    startPolyMode();
    polymode = true;
  }
}

function startPolyMode() {
  map.on('click', addPoint);
}

function endPolyMode() {
  L.polygon(points).addTo(map);
  map.off('click', addPoint);

  landmarkName = prompt("What is the name of this landmark?");
  var data = {points: points, name: landmarkName};
  fb.child('vpc').child('polyTemp').push(data);

  // var polydata = "[\n";
  // for (var i = 0; i < points.length; ++i) {
  //   polydata += '\t['+points[i].lat+', '+points[i].lng+'],\n';
  // }
  // polydata += "]";

  // $('body').append('<pre id="polydata">'+polydata+'</pre>');
  // $('#polydata').dialog({title: 'Send this to Justin with the name of the landmark!', width: "50%", close: function() {$('#polydata').remove();} });
  // console.log(polydata);

  points = [];
  for (var i = 0; i < markers.length; ++i) {
    map.removeLayer(markers[i]);
  }
  markers = [];
}

// Download rect
function RectDrawer() {
  var rectX, rectY;
  var latlngStart, latlngEnd;

  this.endRect = function(callback, event) {
    var x = $(".rect").css("left").slice(0, -2);;
    var y = $(".rect").css("top").slice(0, -2);;
    var width = $(".rect").css("width").slice(0, -2);
    var height = $(".rect").css("height").slice(0, -2);

    $(".rect").remove();
    $(".rect-canvas").remove();

    callback(x, y, width, height);
  }

  this.startRect = function(event) {
    $(".rect-canvas").append('<div class="rect"></div>');
    rectX = event.clientX;
    rectY = event.clientY;
    $(".rect").css({ top: rectY, left: rectX });
    $(".rect-canvas").mousemove(this.updateRect);
  }

  this.initialize = function(callback) {
    $("body").append('<div class="rect-canvas"></div>');
    $(".rect-canvas").mousedown(this.startRect.bind(this));
    $(".rect-canvas").mouseup(this.endRect.bind(this, callback));
  }

  this.updateRect = function(event) {
    var xDiff = event.clientX - rectX;
    var yDiff = event.clientY - rectY;

    var newX, newY, newWidth, newHeight;

    if (xDiff < 0) {
      newWidth = Math.abs(xDiff);
      newX = rectX - newWidth;
    }
    else {
      newX = rectX;
      newWidth = xDiff;
    }

    if (yDiff < 0) {
      newHeight = Math.abs(yDiff);
      newY = rectY - newHeight;
    }
    else {
      newY = rectY;
      newHeight = yDiff;
    }

    $(".rect").css({ left: newX+"px", top: newY+"px", width: newWidth+"px", height: newHeight+"px"});
  }
}

// Enable layers
var churchPolys = []
function toggleChurchLayer() {
  if (churchPolys.length == 0) {
    for (var i = 0; i < demolishedChurchColors.length; ++i) {
      var churchColor = demolishedChurchColors[i];
      var church = findData(demolishedChurches, churchColor[0]);
      var newPoly = L.polygon(churchColor.slice(1), {color: 'red', weight: 2});
      newPoly.on('click', (function(name, loc){return function() { L.popup().setLatLng(loc).setContent(name).openOn(map); }})(churchColor[0], church[1]));
      newPoly.on('dblclick', (function (loc) {return function() {map.setLatLng(loc).setZoom(8);}})(church[1]));
      newPoly.addTo(map);
      churchPolys.push(newPoly);
    }

    $('#churches-layer').css('font-weight', 600);

    var newsources = [demolishedChurches];
    if (bridgePolys.length > 0) newsources.push(bridges);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) });
  }
  else {
    for (var i = 0; i < demolishedChurchColors.length; ++i) {
      map.removeLayer(churchPolys[i]);
    }

    $('#churches-layer').css('font-weight', 400);

    var newsources = [bridges];
    if (bridgePolys.length == 0) newsources.push(demolishedChurches,churches,repurposedChurches);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) })

    churchPolys = [];
  }
}

var bridgePolys = [];
function toggleBridgeLayer() {
  if (bridgePolys.length == 0) {
    for (var i = 0; i < bridgeColors.length; ++i) {
      var newPoly = L.polygon(bridgeColors[i].slice(1), { weight: 2 });
      newPoly.addTo(map);
      bridgePolys.push(newPoly);
    }

    $('#bridges-layer').css('font-weight', 600);

    var newsources = [bridges];
    if (churchPolys.length > 0) newsources.push(demolishedChurches);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) });
  }
  else {
    for (var i = 0; i < bridgeColors.length; ++i) {
      map.removeLayer(bridgePolys[i]);
    }

    $('#bridges-layer').css('font-weight', 400);

    var newsources = [demolishedChurches];
    if (churchPolys.length == 0) newsources.push(bridges,churches,repurposedChurches);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) })

    bridgePolys = [];
  }
}

// Firebase auth
var auth = new FirebaseSimpleLogin(fb, fbUserCallback);

function fbUserCallback(error, user) {
  if (error) {
    console.log(error);
    $('#login-text').show();
  }
  else if (user) {
    $('#login-form').hide();
    $('#login-text').show();
    $('#login-text').text("Logged in as " + user.email);
    $('#drawmode').css('display', 'inline');
  }
}

function fbLogin(email, password) {
  auth.login('password', {
    email: email,
    password: password
  }, function(error, user) { 
    if (error)
      console.log(error);
  });
}

function fbSignup(email, password) {

}

// Login form
function showLoginForm(type) {
  var callback;
  if (type == "login") {
    callback = fbLogin;
  }
  else {
    alert("Not working yet. Check back soon!");
    return; //
    callback = fbSignup;
  }

  $('#password').on('keyup', function(e) {
    if (e.keyCode == 13) {
      callback($('#email').val(), $('#password').val());
      $('#password').off('keyup');
    }
  });

  $('#login-form').css('display', 'block');
  $('#login-text').hide();
}

// UTIL
function record(name) {
    console.log('["' + name + '", [' + map.getCenter().lat + ', ' + map.getCenter().lng + '], ' + map.getZoom() + ']');
}
