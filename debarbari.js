var map;
var fb = new Firebase('https://debarbari.firebaseio.com/');

// Demolished Church of the Templari is aka Santa Maria dell'Ascensione
// Demolished Convent of the Celestia is aka Santa Maria de la Celestia
// Demolished Church of Santa Maria dei Servi not really demolished?
// Demolished Church of San Tomà not really demolished?
// Demolished Convent of the Vergini ??
// Demolished Church of San Nicoló di Castello ?
// Demolished Church of San Bartolomeo di Castello ?
// ["Convent of the Crociferi????????", [-67.08668927672144, 22971.533203125], 7]

var REPURPOSEDCHURCHDATA = [{"type":"Feature","properties":{"name":"Church of San Vidal","center":[-74.48760078108175,233.1904296875],"zoom":7}}];
var CHURCHDATA = [{"type":"Feature","properties":{"name":"Church of San Nicolò dei Mendicoli","center":[-72.63993,196.05663999999888],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Giacomo dell'Orio","center":[-67.11875,245.4072300000007],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Sant'Alvise","center":[-62.69431,260.5463899999995],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Santo Stefano","center":[-74.13408,237.17846999999892],"zoom":6}},{"type":"Feature","properties":{"name":"Church of Santa Maria Gloriosa dei Frari","center":[-69.51915,233.6079099999988],"zoom":6}},{"type":"Feature","properties":{"name":"Church of the Carmini","center":[-72.73148,215.45850000000064],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Giobbe","center":[-62.84512,227.24683000000005],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Angelo Raffaele","center":[-72.90026,205.29613999999856],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Pantalon","center":[-70.54686,224.7419399999999],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Giacomo at Rialto","center":[-69.75616,267.9291999999987],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Santi Maria e Donato","center":[-61.90793,322.87183000000005],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Madonna dell'Orto","center":[-63.77278,267.40186000000176],"zoom":7}},{"type":"Feature","properties":{"name":"Church of S. Michele in Isola","center":[-64.97936,307.63378999999986],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Santa Maria dei Miracoli","center":[-70.24832,288.3967300000004],"zoom":7}},{"type":"Feature","properties":{"name":"Church of Santi Apostoli","center":[-68.39109,278.8386199999986],"zoom":7}},{"type":"Feature","properties":{"name":"Church of SS. Giovanni e Paolo","center":[-70.71447,302.4702099999995],"zoom":6}},{"type":"Feature","properties":{"name":"Church of Santa Maria Formosa","center":[-73.6154,296.5925300000017],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Giovanni Crisostomo","center":[-69.72191,280.2778299999991],"zoom":7}},{"type":"Feature","properties":{"name":"Former Convent of San Salvador","center":[-72.7119,273.9167500000003],"zoom":7}},{"type":"Feature","properties":{"name":"Convent of San Francesco della Vigna","center":[-72.47528,330.13378999999986],"zoom":6}},{"type":"Feature","properties":{"name":"Church of San Lorenzo","center":[-74.13408,318.7739299999994],"zoom":6}},{"type":"Feature","properties":{"name":"Church of Sant'Agnese","center":[-76.16925,210.1850599999998],"zoom":7}},{"type":"Feature","properties":{"name":"Former Church of San Gregorio","center":[-77.71627,235.43163999999888],"zoom":6}},{"type":"Feature","properties":{"name":"Former Church of the Carità","center":[-74.48466,220.1935999999987],"zoom":7}},{"type":"Feature","properties":{"name":"Church of the San Fantin","center":[-75.79403,253.0866700000006],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Giovanni in Bragora","center":[-76.94545,330.24365000000034],"zoom":6}},{"type":"Feature","properties":{"name":"Church of San Zaccaria","center":[-76.52706,312.9951199999996],"zoom":6}},{"type":"Feature","properties":{"name":"Church of San Martino near Arsenale","center":[-77.57523,344.73461999999927],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Giorgio Maggiore and Cloister of the Cipressi","center":[-81.43359,294.8676799999994],"zoom":6}},{"type":"Feature","properties":{"name":"Basilica of Saint Mark","center":[-76.05321,287.6826199999996],"zoom":7}},{"type":"Feature","properties":{"name":"Church of San Pietro di Castello","center":[-76.58836,391.23975000000064],"zoom":6}}];
var BRIDGEDATA = [{"type":"Feature","properties":{"name":"Ponte de la Croze","center":[-82.85133180485437,233.77270507812],"zoom":7},"geometry":{"type":"Polygon","coordinates":[[[233.05859375,-82.81777053087616],[233.1025390625,-82.79055913124414],[233.25634765625,-82.76871533361016],[233.56396484375,-82.75228879254695],[233.87158203125,-82.74680493977701],[234.1572265625,-82.75776847369394],[234.39892578124636,-82.7878322917037],[234.46484375,-82.82048597979633],[234.728515625,-82.76598018045308],[234.99218749999636,-82.75502915437806],[234.97021484375,-82.71932299211134],[234.4208984375,-82.70830090211909],[233.89355468749636,-82.7055427576717],[233.43212890625,-82.71381404388949],[232.97070312499636,-82.72207589462259],[233.05859375,-82.81777053087616]]]}}];
var DEMOLISHEDCHURCHDATA = [{"type":"Feature","properties":{"name":"Demolished Church of Corpus Domini","center":[-69.1018992122562,211.81103515625],"zoom":7},"geometry":{"type":"Polygon","coordinates":[[[209.0974121093714,-69.88273756578228],[211.8220214843714,-69.41117991073664],[211.7561035156214,-69.26455369963442],[212.3273925781214,-69.16365280893004],[212.2834472656214,-69.08571596245292],[212.3933105468714,-69.12471931702487],[212.7668457031214,-69.08571596245292],[212.7448730468714,-68.78699612875253],[211.0969238281214,-68.50824330930786],[210.8552246093714,-68.53227324448468],[210.83325195311775,-68.42795738330774],[210.59155273436775,-68.37158650017851],[210.3278808593714,-68.42795738330774],[210.2180175781214,-68.4118657814897],[208.8337402343714,-68.44403750368588],[208.4162597656214,-68.55627744766633],[207.5153808593714,-69.48028595515795],[207.8229980468714,-69.42655612745617],[208.06469726561775,-69.45727543415194],[209.0974121093714,-69.88273756578228]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Santa Lucia","center":[-67.92720481451185,216.73291015625],"zoom":7},"geometry":{"type":"Polygon","coordinates":[[[216.26049804687503,-68.3777588040255],[216.41430664062503,-68.4260594632869],[217.5788574218714,-68.16725749163216],[217.55688476562503,-67.94658647799025],[217.68872070312503,-67.99580791057062],[218.3259277343714,-67.82307240426248],[218.30395507812503,-67.49046591382543],[216.41430664062503,-67.18705990620384],[216.0627441406214,-67.18705990620384],[214.56860351562503,-67.51557549189853],[215.0520019531214,-67.5907441297335],[215.16186523437503,-67.56571457626906],[216.23852539062503,-67.69889813270467],[216.26049804687503,-68.3777588040255]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Stin","center":[-68.9869706187376,237.189453125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[235.38769531250003,-69.24474575881392],[235.36572265625003,-69.12029242436243],[235.45361328125003,-69.07343803362114],[235.45361328125003,-69.00296726792594],[235.49755859375003,-68.93226892999554],[235.84912109375003,-68.94799937058956],[235.93701171875003,-68.91652722031029],[235.95898437500003,-68.55134177641668],[236.20068359375003,-68.31801267423911],[236.46435546875003,-68.54333608795142],[236.53027343750003,-68.8771235986435],[237.82666015625003,-68.88500996612885],[237.95849609375003,-68.92439948421953],[237.93652343750003,-68.97942647203196],[238.02441406250003,-69.01864708275687],[238.02441406250003,-69.17482864559223],[237.73876953125003,-69.27574763790886],[235.38769531250003,-69.24474575881392]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Tomà","center":[-71.47610617440442,233.16845703125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[233.5255126953125,-71.50740543388952],[233.0531005859375,-71.46226535253169],[233.0531005859375,-71.34370086416453],[233.2947998046875,-71.29115957491051],[233.4046630859375,-71.28063411935487],[233.7672119140625,-71.27712435896531],[234.0089111328125,-71.29817335829692],[233.83312988280886,-71.29817335829692],[233.6903076171875,-71.35768769904665],[233.5255126953125,-71.50740543388952]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Geminiano","center":[-76.23475200291313,269.71997070312136],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[269.29150390625,-76.33548734032775],[269.357421875,-76.42787617423569],[269.86279296875,-76.42787617423569],[269.81884765625,-76.1488395145761],[269.55517578124636,-76.08082128889951],[269.37939453124636,-76.08606516038105],[269.357421875,-75.9543808290349],[268.91796875,-75.71961976750777],[268.58837890625,-75.9543808290349],[268.58837890625,-76.22691386099115],[267.57763671875,-76.22172246909756],[267.62158203125,-76.28389166568326],[268.36865234374636,-76.26319948544557],[268.41259765625,-76.32002882832163],[268.6982421875,-76.28905989224782],[269.29150390625,-76.33548734032775]]]}},{"type":"Feature","properties":{"name":"Demolished Convent of the Celestia","center":[-73.64481249034911,339.0107421875],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[338.10986328125,-73.81577472911373],[339.54907226562136,-73.86758836775498],[339.527099609375,-73.4827908024135],[339.40625,-73.38285170695262],[339.241455078125,-73.38285170695262],[339.0107421875,-73.47033054575189],[339.0107421875,-73.53564475830113],[337.044189453125,-73.37031793572045],[336.846435546875,-73.41101902427215],[336.85742187499636,-73.4827908024135],[337.219970703125,-73.50768383705378],[337.296875,-73.55425967455997],[337.296875,-73.61925031071645],[337.263916015625,-73.74541518464878],[337.6923828125,-73.76073609910186],[338.10986328125,-73.81577472911373]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Vio","center":[-76.34930387697642,219.0015869140625],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[219.314697265625,-76.50496683700388],[219.1279296875,-76.52017372998378],[219.094970703125,-76.41336716829349],[218.589599609375,-76.28769754416287],[218.62255859375,-76.11138632710032],[219.10595703125,-76.07219254194538],[219.34765625,-76.0460024591146],[219.611328125,-76.05648434511335],[220.215576171875,-76.26449031710384],[220.523193359375,-76.34682831651112],[220.611083984375,-76.37245836674833],[220.281494140625,-76.34682831651112],[219.32568359374636,-76.41591991773683],[219.314697265625,-76.50496683700388]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Daniele","center":[-76.74165712324191,377.737548828125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[377.5947265625,-77.18797995891369],[377.57275390625,-77.04705573825332],[377.4189453125,-76.93419659884303],[378.14404296875,-76.94897243900978],[378.2099609375,-76.73059140188447],[377.990234375,-76.64525109698701],[377.44091796874636,-76.59985119832805],[377.44091796874636,-76.50859265815492],[377.1552734375,-76.34483448969772],[376.82568359375,-76.47803669341259],[376.759765625,-76.57962446269698],[375.5732421875,-76.53908030116168],[375.55126953125,-76.51876279000416],[374.16699218749636,-76.46783616427354],[373.6396484375,-76.44741226253805],[373.83740234375,-76.50350474582606],[374.3427734375,-76.7255863646056],[374.5625,-76.79548708199965],[375.08984374999636,-76.9045951740572],[375.3974609375,-76.97847446285196],[375.92480468749636,-77.12499601127699],[377.5947265625,-77.18797995891369]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Bartolomeo di Castello","center":[-71.18952520749146,278.113525390625],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[278.970458984375,-71.86082569885626],[279.168212890625,-71.87443079301684],[279.71752929687136,-71.71737171750966],[279.71752929687136,-71.62112408423226],[279.541748046875,-71.57972464147159],[279.38793945312136,-71.57972464147159],[279.322021484375,-71.55899098297945],[279.278076171875,-71.47582958781447],[279.146240234375,-71.44107169347664],[277.849853515625,-71.37136597698985],[277.87182617187136,-71.01189964207123],[277.608154296875,-70.69638113351972],[277.300537109375,-70.99766683475407],[277.300537109375,-71.33641795013891],[277.168701171875,-71.41321982479417],[277.146728515625,-71.47582958781447],[276.883056640625,-71.55899098297945],[276.839111328125,-71.60733431781429],[277.915771484375,-71.6761828235278],[278.091552734375,-71.66243317464084],[278.618896484375,-71.64867350613457],[279.014404296875,-71.66243317464084],[278.970458984375,-71.86082569885626]]]}},{"type":"Feature","properties":{"name":"Demolished Convent of San Cristoforo","center":[-66.46724418515859,303.61279296875],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[302.40429687499994,-66.68116489204975],[302.40429687499994,-66.23526390988222],[302.58007812499994,-66.12917912887359],[304.11816406249994,-66.16459039184694],[304.24999999999994,-66.24408414728946],[304.82128906249994,-66.31453460711276],[304.84326171874994,-66.72445127669364],[304.42578124999994,-66.72445127669364],[304.24999999999994,-66.67249845765224],[304.00830078124994,-66.71580010181762],[303.92041015624994,-66.75902549226959],[303.54687499999994,-66.75902549226959],[302.88769531249994,-66.71580010181762],[302.40429687499994,-66.68116489204975]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Ternita","center":[-74.5506480395836,335.54455566405886],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[333.374755859375,-74.5245491811977],[333.374755859375,-74.15979353697823],[333.52856445312136,-74.15979353697823],[333.660400390625,-74.00432854431851],[333.858154296875,-74.16574321869963],[333.968017578125,-74.18951999242233],[334.011962890625,-74.45460203620793],[334.165771484375,-74.44875908699744],[334.209716796875,-74.31377347958994],[334.341552734375,-74.24288951092178],[337.088134765625,-74.50126794273844],[337.219970703125,-74.53617689233766],[337.329833984375,-74.7669334321176],[336.912353515625,-74.85259007182832],[335.220458984375,-74.73827533358622],[334.583251953125,-74.67504049666624],[334.099853515625,-74.69231190195401],[334.011962890625,-74.64044010783257],[333.792236328125,-74.58839528266091],[333.52856445312136,-74.58839528266091],[333.374755859375,-74.5245491811977]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Boldo","center":[-68.2256180821868,252.8284912109375],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[252.37255859374994,-68.59166713963641],[251.44970703124994,-68.37489452701037],[251.49365234374994,-68.18044712142074],[251.88916015624994,-68.10709955500181],[251.93310546874994,-67.72852187103126],[252.08691406249994,-67.52853345529114],[252.30664062499994,-67.70361637858373],[252.32861328124994,-68.16416797431721],[252.6142578124963,-68.14787722609061],[252.94384765624994,-68.19671467434947],[253.18554687499994,-68.22921502546956],[253.27343749999994,-68.41519537012461],[252.37255859374994,-68.59166713963641]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Santa Margherita","center":[-71.42280436921011,221.929443359375],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[221.11096191405886,-71.57434718247305],[221.11096191405886,-71.05942910920923],[221.2977294921875,-70.85962618017433],[221.4844970703125,-71.02745463750888],[221.52844238280886,-71.23259894906792],[221.6822509765625,-71.17622300894125],[221.8909912109375,-71.21852031911796],[221.9569091796875,-71.21499906308587],[222.03381347655886,-71.24315121052265],[222.1107177734375,-71.23963442897569],[222.3414306640625,-71.31685621824427],[222.37438964843386,-71.36583685353393],[222.7149658203125,-71.47732553001552],[222.5831298828125,-71.51896677315835],[222.6490478515625,-71.5432155449046],[222.3524169921875,-71.6639970572094],[222.3304443359375,-71.63301242092801],[222.1436767578125,-71.64334627546427],[222.0667724609375,-71.63645766631609],[221.8800048828125,-71.63990228446094],[221.5504150390625,-71.74294966502434],[221.11096191405886,-71.57434718247305]]]}},{"type":"Feature","properties":{"name":"Demolished Church of the Templari","center":[-76.75802477369372,266.61083984375],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[266.2537841796875,-76.30608240387541],[266.6053466796875,-76.48301333028405],[266.6273193359375,-76.54148617536116],[266.8909912109375,-76.54655892377545],[266.91296386718386,-76.71791069067814],[266.8140869140625,-76.80028602213964],[266.7481689453125,-76.74042705394425],[266.7042236328125,-76.88957287775929],[266.6492919921875,-76.92413369663485],[266.5833740234375,-76.71791069067814],[266.4405517578125,-76.6928480955955],[265.1771240234375,-76.6928480955955],[264.7926025390625,-76.8077495467297],[264.7486572265625,-76.767895717816],[264.2872314453125,-76.73292580317441],[263.9466552734375,-76.71290191418083],[263.62805175780886,-76.66019669721783],[263.5621337890625,-76.61990144409518],[263.9906005859375,-76.55923251663366],[264.4300537109375,-76.56683099921479],[264.5399169921875,-76.5059238907856],[266.0120849609375,-76.51355220106488],[266.0120849609375,-76.49065445765041],[266.2537841796875,-76.30608240387541]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Sant'Agostin","center":[-68.9001312167013,246.604736328125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[245.61047363281253,-69.15564494817176],[245.98400878906253,-69.28360817975692],[247.60998535156253,-69.26426848024995],[247.59899902343753,-69.04647461690338],[247.45617675781253,-68.97600385120818],[247.43420410156253,-68.90137114260264],[247.31335449218753,-68.83437897620026],[247.08264160156253,-68.81858647039392],[246.0609130859339,-68.8225356566049],[246.04992675781253,-68.47229024715345],[245.81921386718753,-68.25867607947808],[245.56652832031253,-68.46025273633592],[245.5555419921839,-68.93675513225699],[245.54455566406253,-69.00343615627386],[245.61047363281253,-69.01518233182652],[245.61047363281253,-69.15564494817176]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Santa Maria dei Servi","center":[-64.33752904242549,255.4542236328125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[253.93261718749997,-64.25673714205656],[253.96557617187497,-63.912540112600624],[254.22924804687497,-63.77269305529185],[255.97607421874997,-63.96540296965367],[256.074951171875,-63.787192410867775],[256.33862304687136,-63.72915002673898],[256.59130859374636,-63.78236012456954],[256.67919921874636,-63.89329238568132],[256.701171875,-63.998990793391584],[256.7890625,-64.08517343404512],[256.96484375,-64.20918755449797],[257.03076171875,-64.3705212351913],[256.975830078125,-64.47440899113265],[256.492431640625,-64.58729050272665],[256.4814453125,-64.70437702788739],[255.39379882812497,-64.57790163288426],[255.39379882812497,-64.40361935962014],[253.93261718749997,-64.25673714205656]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Santa Croce","center":[-70.31133703000764,212.2449951171875],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[212.5745849609375,-69.79172023539508],[212.8272705078125,-69.84452543872],[212.8712158203125,-70.3653107278946],[211.9263916015625,-70.4642424776608],[211.87145996093386,-70.51170430949507],[211.8604736328125,-70.5626923957771],[211.1573486328125,-70.64980059680892],[210.8717041015625,-70.63168424486751],[210.8057861328125,-70.64980059680892],[210.7178955078125,-70.66790055819025],[210.69592285155886,-70.75094963905889],[210.4981689453125,-70.77615685372052],[210.5311279296875,-70.43863985493769],[210.7398681640625,-70.41300480984673],[210.7947998046875,-70.35796322594342],[212.3218994140625,-70.11771878099232],[212.3438720703125,-69.8256817196286],[212.5745849609375,-69.79172023539508]]]}},{"type":"Feature","properties":{"name":"Demolished Convent of the Crociferi","center":[-67.02887556543278,292.19799804687136],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[291.330078125,-67.91783016163696],[290.29736328125,-67.71959172500213],[290.154541015625,-67.75689031381908],[289.30859375,-67.61983697506491],[289.2646484375,-67.65729481173132],[288.693359375,-67.59483183123537],[288.814208984375,-67.33909717412958],[288.67138671875,-67.30957340456658],[288.71533203125,-67.19535273434043],[288.924072265625,-67.1189019644624],[288.9130859375,-67.03793956491135],[289.165771484375,-66.9823874214957],[289.27563476562136,-66.99521847173324],[289.319580078125,-66.96954957109779],[290.659912109375,-66.67672781310351],[290.73681640625,-66.37599165455998],[291.033447265625,-66.24850187778716],[291.13232421874636,-66.23527616799423],[293.384521484375,-66.55077628550684],[293.406494140625,-66.4198031782024],[293.758056640625,-66.40666780940923],[294.087646484375,-66.49846999532913],[294.065673828125,-66.81927119728009],[294.197509765625,-66.86660160701103],[294.197509765625,-67.15291012916154],[294.83471679687136,-66.99521847173324],[294.83471679687136,-67.19535273434043],[291.330078125,-67.91783016163696]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Provolo","center":[-76.05188901233623,305.601318359375],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[305.35961914062506,-75.7156449447746],[305.09594726562506,-75.79070301026474],[305.04101562500006,-75.89459892038997],[304.94213867187506,-76.21477949253087],[305.09594726562506,-76.36959604438674],[306.10668945312506,-76.36702993165332],[305.76611328125006,-76.06871412970068],[305.5024414062464,-76.05822248010168],[305.5793457031214,-75.82275129990481],[305.35961914062506,-75.7156449447746]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Santa Marina","center":[-71.07049277109596,288.27587890625],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[288.40771484375,-71.42236508002641],[288.45166015624636,-71.25779513853915],[288.396728515625,-71.27536946631662],[288.3857421875,-71.19439523450859],[288.352783203125,-71.16968369217894],[287.94628906249636,-71.12724791200355],[288.01220703125,-70.84556086856742],[287.92431640625,-70.83837705288332],[287.814453125,-70.63616996201033],[287.5947265625,-70.83119063322684],[287.48486328125,-71.11662451518065],[286.748779296875,-71.04920851664718],[286.759765625,-71.02787092139529],[286.69384765625,-71.01719341089108],[286.583984375,-71.09181408224444],[286.56201171875,-71.13078775891913],[286.408203125,-71.13432696332724],[286.26538085937136,-71.17674733816777],[286.287353515625,-71.21907538485328],[286.56201171875,-71.26834165078596],[286.8916015625,-71.37698629693078],[286.9794921875,-71.30696305286402],[287.19921875,-71.31397683625043],[287.5947265625,-71.33500289792006],[288.133056640625,-71.38397463096162],[288.27587890625,-71.40492439378862],[288.28686523437136,-71.49196945803202],[288.40771484375,-71.42236508002641]]]}},{"type":"Feature","properties":{"name":"Demolished Convent of the Vergini","center":[-77.33662698794667,346.3551025390625],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[346.6077880859375,-77.02392737653255],[346.8055419921875,-77.09702369912489],[346.7835693359375,-77.18661288789033],[346.0255126953125,-77.14068507138154],[345.4652099609375,-77.1697111006288],[345.4102783203125,-77.18902562275846],[344.3226318359375,-77.1697111006288],[344.2347412109375,-77.14068507138154],[343.7293701171875,-77.10673893172017],[343.3338623046875,-77.12857165194421],[343.28991699218386,-77.21071993760559],[343.1580810546875,-77.21312816306073],[342.5867919921875,-77.22275656067232],[342.5208740234375,-77.20108252917497],[342.3670654296875,-77.20108252917497],[342.4219970703125,-77.09459375528782],[342.0484619140625,-76.99947068765482],[342.0594482421875,-76.9602447731489],[341.2574462890625,-76.80464761693214],[341.2574462890625,-76.73490336571854],[341.34533691405886,-76.73240574853811],[341.3892822265625,-76.65977162584801],[341.5650634765625,-76.64720870888027],[341.9166259765625,-76.67483165651097],[341.9166259765625,-76.73490336571854],[342.4879150390625,-76.78226958305513],[342.8724365234375,-76.87649923513634],[343.03723144530886,-76.88144018496887],[343.3558349609375,-76.97006225208736],[343.5865478515625,-77.00191841435652],[343.9271240234375,-77.00191841435652],[344.4544677734375,-76.997022503364],[344.8499755859375,-76.99212476169066],[344.4105224609375,-76.88144018496887],[345.1905517578125,-76.85424209942107],[345.64099121093386,-76.8987189766075],[345.9486083984375,-77.01903969558069],[346.6077880859375,-77.02392737653255]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Severo","center":[-75.3617294907569,308.4962158203125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[308.062255859375,-75.56652420425424],[307.0625,-75.54748037970197],[306.90869140625,-75.476528982336],[307.073486328125,-75.26715785420375],[308.029296875,-75.27547861148557],[308.05126953125,-75.09415481244135],[308.1611328125,-75.09696099512026],[308.38085937499636,-74.93050310445193],[308.556640625,-75.102571800012],[308.6005859375,-75.12499422651703],[308.611572265625,-75.32806931624464],[308.71044921875,-75.32806931624464],[308.677490234375,-75.30594845908367],[309.36962890625,-75.30318104216586],[309.380615234375,-75.33635617437291],[309.864013671875,-75.3391174352702],[310.02880859375,-75.36945750460184],[309.76513671875,-75.38322798011848],[309.76513671875,-75.457368072859],[308.72143554687136,-75.42995210466243],[308.66650390625,-75.41622501966324],[308.57861328125,-75.42995210466243],[308.523681640625,-75.41073061665905],[308.13916015625,-75.41897145620194],[308.062255859375,-75.56652420425424]]]}},{"type":"Feature","properties":{"name":"Demolished Church of Sant'Angelo","center":[-73.9194260357383,241.726806640625],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[242.11132812499991,-74.23999415919089],[241.29833984374628,-74.23999415919089],[240.24365234374991,-74.09680550493043],[240.19970703124991,-73.8492396648789],[240.59521484374991,-73.8126956470061],[240.61718749999991,-73.75772793089492],[240.83691406249991,-73.70257769542634],[240.94677734374991,-73.7209814213999],[240.94677734374991,-73.3113687574668],[241.05114746093378,-73.28622278298694],[241.00720214843741,-73.23581982724892],[241.18298339843741,-72.96876137269766],[241.45764160156241,-73.22003850105423],[241.49060058593741,-73.27993051227747],[241.54553222656241,-73.28622278298694],[241.64440917968378,-73.69029724517942],[241.80920410155878,-73.7117820998229],[241.86413574218741,-73.86140306055954],[242.07287597656241,-73.88570297286405],[242.09484863281241,-73.92511400062698],[242.45739746093741,-74.01269131914665],[242.42443847656241,-74.12075844221289],[242.11682128906241,-74.14467605098616],[242.11132812499991,-74.23999415919089]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Nicoló di Castello","center":[-78.64299357031803,374.826171875],"zoom":7},"geometry":{"type":"Polygon","coordinates":[[[372.6234130859375,-78.84586477756463],[372.6453857421875,-78.78873911647655],[372.4586181640625,-78.74623632718738],[372.2718505859375,-78.72279154184733],[372.2059326171875,-78.70784685626724],[372.2059326171875,-78.6564583030964],[372.7113037109375,-78.63712771980896],[374.0845947265625,-78.59405356518913],[374.2713623046875,-78.59189560261221],[374.28234863280886,-78.43982571202942],[374.3592529296875,-78.43545139270104],[374.5240478515625,-78.27909336336367],[374.8206787109375,-78.43982571202942],[374.8536376953125,-78.46821875001226],[374.87561035155886,-78.53781447562766],[375.12829589843386,-78.53347699562791],[375.5128173828125,-78.49218950805961],[375.7874755859375,-78.49218950805961],[375.9412841796875,-78.52262615886973],[376.2818603515625,-78.60483729423646],[376.3477783203125,-78.75049380587993],[372.6234130859375,-78.84586477756463]]]}},{"type":"Feature","properties":{"name":"Demolished Convent of Sant'Anna","center":[-78.510263861155,392.766845703125],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[394.67846679687506,-78.77111241792262],[394.52465820312506,-78.57378705885354],[394.10717773437506,-78.53911980522896],[392.5690917968714,-78.44324553704666],[392.32739257812506,-78.35098676444753],[392.26147460937506,-78.19559551484951],[392.15161132812506,-78.17770611434318],[391.95385742187506,-78.02908908770314],[391.82202148437506,-78.02908908770314],[391.69018554687506,-78.18218098360259],[391.51440429687506,-78.18218098360259],[391.60229492187506,-78.34657530592231],[390.23999023437506,-78.36421120024247],[390.13012695312506,-78.43449032006517],[390.13012695312506,-78.4607362412184],[390.10815429687506,-78.56079905628387],[391.84399414062506,-78.81779517880165],[393.27221679687506,-78.80932176981379],[393.79956054687506,-78.86428510295512],[394.26098632812506,-78.8600666945095],[394.23901367187506,-78.80084198145123],[394.12915039062506,-78.77111241792262],[394.67846679687506,-78.77111241792262]]]}},{"type":"Feature","properties":{"name":"Demolished Hospital and Convent of Sant’Antonio","center":[-80.297927149974,387.559326171875],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[383.76904296875,-80.65157174975604],[384.845703125,-80.65157174975604],[384.845703125,-80.57679500095375],[385.021484375,-80.54456547475323],[385.17529296875,-80.53379788767727],[385.13134765625,-80.47977625730127],[385.2412109375,-80.43270891952537],[385.43896484375,-80.39634546485924],[385.52685546875,-80.42181432014563],[388.64697265625,-80.38905625626894],[388.625,-80.32320470176755],[388.5810546875,-80.24950874391209],[388.5810546875,-80.17897960851735],[388.55908203125,-80.11544385145774],[388.712890625,-80.09667905448849],[382.5166015625,-80.05527150294044],[382.14306640625,-80.06658154383581],[382.05517578125,-80.34886691363903],[383.76904296875,-80.65157174975604]]]}},{"type":"Feature","properties":{"name":"Demolished Convent of San Domenico","center":[-78.94087000996285,379.099853515625],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[376.69384765625,-78.75010723419547],[377.2431640625,-78.75436151048602],[377.22119140625,-78.43955593881574],[377.39697265625,-78.42643298023823],[377.61669921875,-78.2144414372701],[377.8583984375,-78.43518326314289],[377.92431640624636,-78.4613946830654],[377.9462890625,-78.47883615301505],[377.990234375,-78.75010723419547],[379.24267578125,-78.75861418644381],[379.2646484375,-78.7373347975387],[379.85791015625,-78.71174663705024],[380.71484375,-78.8010530549164],[380.69287109375,-78.83066538674838],[380.51708984375,-78.83488935547658],[380.4951171875,-78.85176934243017],[380.51708984375,-78.94415635223396],[380.16552734375,-78.93997352070996],[379.748046875,-78.96922029731941],[379.7919921875,-79.044073275343],[378.869140625,-79.03992807420312],[378.58349609375,-78.96504690410482],[378.4736328125,-78.95669540222563],[378.45166015625,-78.93997352070996],[378.166015625,-78.94833760928101],[378.14404296875,-79.04821691564547],[377.92431640624636,-79.04821691564547],[377.9462890625,-78.9983900920857],[377.90234375,-78.93578911413842],[377.7705078125,-78.92741557356952],[377.638671875,-78.919035725959],[377.52880859375,-78.92741557356952],[377.462890625,-78.95669540222563],[377.375,-78.96504690410482],[377.2431640625,-78.93997352070996],[376.95751953125,-78.94415635223396],[376.8037109375,-79.10194246068241],[376.43017578125,-78.96922029731941],[376.4521484375,-78.8010530549164],[376.69384765625,-78.75010723419547]]]}},{"type":"Feature","properties":{"name":"Demolished Church of San Paterniano","center":[-73.67417651166814,259.2884521484375],"zoom":8},"geometry":{"type":"Polygon","coordinates":[[[258.73364257812,-73.75053534085686],[258.70068359375,-73.4570942965135],[258.986328124996,-73.41653884393622],[259.173095703125,-73.44774394766795],[259.2939453125,-73.71068261437539],[259.22802734375,-73.7413470232409],[258.73364257812,-73.75053534085686]]]}}];

function findData(list, val) {
  for (var i = 0; i < list.length; i++) {
    if (list[i].properties && list[i].properties.name == val) return list[i];
  }

  return null;
}

function findData_(list, val) {
  for (var i = 0; i < list.length; i++) {
    if (list[i].name == val) return list[i];
  }

  return null;
}

function getAutoCompleteNames(datasets) {
  var names = [];
  for (var i = 0; i < datasets.length; ++i) {
    for (var j = 0; j < datasets[i].length; ++j) {
      if (datasets[i][j].properties && datasets[i][j].properties.name)
        names.push(datasets[i][j].properties.name);
    }
  }

  return names;
}

function debarbariInit() {
  // jQuery init
  $(function() {
    // Register handlers
    $("#header").hover(
      function () { // onmouseenter
        $("#header").animate({ opacity: 1.0 }, 250); 
      },
      function () { // onmouseleave
        $("#header").animate({ opacity: 0.6 }, 250); 
      }
    );

    $(".dl").click(function () { 
      this.href = getData(); 
      setTimeout(function() { 
        $(".dl").attr("href", "#");
      }, 100); 
    });

    rectDrawer = new RectDrawer;
    $("#select").click(rectDrawer.initialize.bind(rectDrawer, downloadSection));

    $("#minus-sign").click(hideHeader);
    $("#plus-sign").click(showHeader);

    $("#churches-layer").click(toggleChurchLayer);
    $("#bridges-layer").click(toggleBridgeLayer);

    $('#drawmode').click(togglePolyMode);

    $('#login-link').click(function () {
      showLoginForm('login');
    });
    $('#signup-link').click(function () {
      showLoginForm('signup');
    })

    // function showdrawicon() {
    //   if(window.location.hash == '#color') {
    //     $('#drawmode').css('display', 'inline');
    //   }
    //   else {
    //     $('#drawmode').css('display', 'none');
    //   }
    // }
    // window.onhashchange = showdrawicon;
    // showdrawicon();

    // Initialize search
    var churchNames = getAutoCompleteNames([CHURCHDATA, DEMOLISHEDCHURCHDATA, REPURPOSEDCHURCHDATA, BRIDGEDATA]); //churches_.map(function (e) { return e.name; });
    // for (var i = 0; i < demolishedChurches.length; ++i) {
    //   churchNames.push(demolishedChurches[i][0]);
    // }
    // for (var i = 0; i < repurposedChurches.length; ++i) {
    //   churchNames.push(repurposedChurches[i][0]);
    // }
    // for (var i = 0; i < bridges.length; ++i) {
    //   churchNames.push(bridges[i][0]);
    // }
    $(".search").autocomplete({ source: churchNames });
    $(".search").on("autocompleteselect", function (event, ui) {
      var church = findData(CHURCHDATA, ui.item.value) || findData(REPURPOSEDCHURCHDATA, ui.item.value) || findData(DEMOLISHEDCHURCHDATA, ui.item.value) || findData(BRIDGEDATA, ui.item.value);
      map.setView(church.properties.center, 8 /* LOL IGNORE ZOOM */, { animate: true });
    });
    
    // Initialize leaflet map
    map = L.map('map', { center: [-73, 294/*22973.5*/], zoom: 3, attributionControl: false });
    new L.Control.Attribution({ prefix: false }).addAttribution('<a href="http://veniceprojectcenter.org">Venice Project Center</a>').addTo(map);
    L.tileLayer('tiles2/{z}/{x}/{y}.png', {minZoom: 2, maxZoom: 8, tms: true}).addTo(map);

    var tms2 = L.tileLayer('tiles2/{z}/{x}/{y}.png', {minZoom: 2, maxZoom: 8, tms: true});
    var miniMap = new L.Control.MiniMap(tms2, { toggleDisplay: true }).addTo(map);
  });
}

function getCanvasFromMap() {
  var c = document.createElement("canvas");
  c.width = $("#map").width();
  c.height = $("#map").height();
  var canvas = c.getContext("2d");

  var imgs = $(".leaflet-tile-container.leaflet-zoom-animated").children();

  for (i in imgs) {
    if (isNaN(i)) continue;
    var img = imgs[i];
    var rect = img.getBoundingClientRect();

    canvas.drawImage(img, rect.left, rect.top);
  }

  return c;
}

function getData() {
  var c = getCanvasFromMap();

  var img_url = c.toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
  return img_url;
}

function hideHeader() {
  $("#header").animate({height: 0, width: 0}, 250, function () {
    $("#header").css('display', 'none');
    $("#mini-header").css('display', 'block');
  });
}

function showHeader() {
  $("#header").css({height: "auto", width: "auto"});
  var autoWidth = $("#header").css("width");
  var autoHeight = $("#header").css("height");
  $("#header").css({height: 0, width: 0, display: "block"});

  $("#mini-header").css({display: "none"});
  $("#header").animate({height: autoHeight, width: autoWidth}, 250);
}

function downloadSection(x, y, width, height) {
  var canvas = getCanvasFromMap();
  var ctx = canvas.getContext('2d');

  var selection = ctx.getImageData(x, y, width, height);
  canvas.width = width;
  canvas.height = height;
  ctx.putImageData(selection, 0, 0);

  var link = document.createElement("a");
  link.href = canvas.toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
  link.download = "debarbari.png";
  var theEvent = document.createEvent("MouseEvent");
  theEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
  link.dispatchEvent(theEvent);
}

function addRect(x, y, width, height) {
  var mapBounds = map.getBounds();

  var mapWidth = (mapBounds.getEast() - mapBounds.getWest()) * (width / window.innerWidth);
  var mapHeight = (mapBounds.getNorth() - mapBounds.getSouth()) * (height / window.innerHeight);

  var mapLng = ((mapBounds.getEast() - mapBounds.getWest()) * (x / window.innerWidth)) + mapBounds.getWest();
  var mapLat = ((mapBounds.getNorth() - mapBounds.getSouth()) * (y / window.innerHeight)) + mapBounds.getSouth();

  var rectBounds = [[mapLat+mapHeight, mapLng], [mapLat, mapLng+mapWidth]];
  new L.rectangle(rectBounds, {fillColor: "#ff7800", weight: 1}).addTo(map);
  console.log(rectBounds.toString());
}

// Draw poly
var points = [];
var markers = [];

var circleIcon = L.icon({
  // lol...
  iconUrl: "http://www.rand.org/content/dam/rand/www/external/pubs/research_briefs/RB9385/images/circle1.gif", 
  iconSize: [12, 12],
  iconAnchor: [6, 6]
});

function addPoint(event) {
  var marker = new L.Marker(event.latlng, {icon: circleIcon});
  marker.addTo(map);
  markers.push(marker);
  points.push(event.latlng);
}

var polymode = false;
function togglePolyMode() {
  if (polymode) {
    endPolyMode();
    polymode = false;
  }
  else {
    startPolyMode();
    polymode = true;
  }
}

function startPolyMode() {
  map.on('click', addPoint);
  $('#drawmode>.icon').css('box-shadow','0 0 5px #fff');
}

function endPolyMode() {
  L.polygon(points).addTo(map);
  map.off('click', addPoint);

  $('#drawmode>.icon').css('box-shadow','0 0 0');

  landmarkName = prompt("What is the name of this landmark?");
  var data = {points: points, name: landmarkName};
  fb.child('vpc').child('polyTemp').push(data);

  // var polydata = "[\n";
  // for (var i = 0; i < points.length; ++i) {
  //   polydata += '\t['+points[i].lat+', '+points[i].lng+'],\n';
  // }
  // polydata += "]";

  // $('body').append('<pre id="polydata">'+polydata+'</pre>');
  // $('#polydata').dialog({title: 'Send this to Justin with the name of the landmark!', width: "50%", close: function() {$('#polydata').remove();} });
  // console.log(polydata);

  points = [];
  for (var i = 0; i < markers.length; ++i) {
    map.removeLayer(markers[i]);
  }
  markers = [];
}

// Download rect
function RectDrawer() {
  var rectX, rectY;
  var latlngStart, latlngEnd;

  this.endRect = function(callback, event) {
    var x = $(".rect").css("left").slice(0, -2);;
    var y = $(".rect").css("top").slice(0, -2);;
    var width = $(".rect").css("width").slice(0, -2);
    var height = $(".rect").css("height").slice(0, -2);

    $(".rect").remove();
    $(".rect-canvas").remove();

    callback(x, y, width, height);
  }

  this.startRect = function(event) {
    $(".rect-canvas").append('<div class="rect"></div>');
    rectX = event.clientX;
    rectY = event.clientY;
    $(".rect").css({ top: rectY, left: rectX });
    $(".rect-canvas").mousemove(this.updateRect);
  }

  this.initialize = function(callback) {
    $("body").append('<div class="rect-canvas"></div>');
    $(".rect-canvas").mousedown(this.startRect.bind(this));
    $(".rect-canvas").mouseup(this.endRect.bind(this, callback));
  }

  this.updateRect = function(event) {
    var xDiff = event.clientX - rectX;
    var yDiff = event.clientY - rectY;

    var newX, newY, newWidth, newHeight;

    if (xDiff < 0) {
      newWidth = Math.abs(xDiff);
      newX = rectX - newWidth;
    }
    else {
      newX = rectX;
      newWidth = xDiff;
    }

    if (yDiff < 0) {
      newHeight = Math.abs(yDiff);
      newY = rectY - newHeight;
    }
    else {
      newY = rectY;
      newHeight = yDiff;
    }

    $(".rect").css({ left: newX+"px", top: newY+"px", width: newWidth+"px", height: newHeight+"px"});
  }
}

// Enable layers
var churchPolys = []
function toggleChurchLayer() {
  if (churchPolys.length == 0) {
    for (var i = 0; i < DEMOLISHEDCHURCHDATA.length; ++i) {
      if (DEMOLISHEDCHURCHDATA[i].geometry) {
        var points = geoJSONToLeaflet(DEMOLISHEDCHURCHDATA[i].geometry.coordinates[0]);
        var church = findData(DEMOLISHEDCHURCHDATA, DEMOLISHEDCHURCHDATA[i].properties.name);
        var newPoly = L.polygon(points, {color: 'red', weight: 2});
        newPoly.on('click', (function(name, loc){return function() { L.popup().setLatLng(loc).setContent(name).openOn(map); }})(DEMOLISHEDCHURCHDATA[i].properties.name, DEMOLISHEDCHURCHDATA[i].properties.center));
        newPoly.on('dblclick', (function (loc) {return function() {map.setLatLng(loc).setZoom(8);}})(DEMOLISHEDCHURCHDATA[i].properties.center));
        newPoly.addTo(map);
        churchPolys.push(newPoly);

        // XXX HACK POLYGON STUFF
        var svg_ = newPoly._container;
        L.DomUtil.setPosition(svg_, new L.Point(0, 0));
        var draggable = new L.Draggable(svg_, svg_);
        draggable.enable();
        draggable.on('dragend', (function (poly, draggable, color, e) {
          var start_ = map.containerPointToLatLng(draggable._startPos);
          var end_ = map.containerPointToLatLng(draggable._newPos);
          var polyLatLngs = poly.getLatLngs();
          for (var j = 0; j < polyLatLngs.length; ++j) {
            polyLatLngs[j].lat += end_.lat - start_.lat;
            polyLatLngs[j].lng += end_.lng - start_.lng;
            color[j+1][0] = polyLatLngs[j].lat;
            color[j+1][1] = polyLatLngs[j].lng;
          }
          L.DomUtil.setPosition(draggable._element, new L.Point(0, 0));
          poly.setLatLngs(polyLatLngs);

          /* print */
          console.log(JSON.stringify(DEMOLISHEDCHURCHDATA));
          // var polyarray = polyLatLngs.map(function (e) {return [e.lat, e.lng];});
          // console.log(JSON.stringify(polyarray));
        }).bind(this, newPoly, draggable, points));
      }
    }

    $('#churches-layer').css('font-weight', 600);

    var newsources = [DEMOLISHEDCHURCHDATA];
    if (bridgePolys.length > 0) newsources.push(BRIDGEDATA);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) });
  }
  else {
    for (var i = 0; i < churchPolys.length; ++i) {
      map.removeLayer(churchPolys[i]);
    }

    $('#churches-layer').css('font-weight', 400);

    var newsources = [BRIDGEDATA];
    if (bridgePolys.length == 0) newsources.push(DEMOLISHEDCHURCHDATA,CHURCHDATA,REPURPOSEDCHURCHDATA);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) })

    churchPolys = [];
  }
}

var bridgePolys = [];
function toggleBridgeLayer() {
  if (bridgePolys.length == 0) {
    for (var i = 0; i < BRIDGEDATA.length; ++i) {
      if (BRIDGEDATA[i].geometry) {
        var points = geoJSONToLeaflet(BRIDGEDATA[i].geometry.coordinates[0]);
        var newPoly = L.polygon(points, { weight: 2 });
        newPoly.addTo(map);
        bridgePolys.push(newPoly);

        // XXX HACK POLYGON STUFF
        var svg_ = newPoly._container;
        L.DomUtil.setPosition(svg_, new L.Point(0, 0));
        var draggable = new L.Draggable(svg_, svg_);
        draggable.enable();
        draggable.on('dragend', (function (poly, color, e) {
          var start_ = map.containerPointToLatLng(draggable._startPos);
          var end_ = map.containerPointToLatLng(draggable._newPos);
          var polyLatLngs = poly.getLatLngs();
          for (var j = 0; j < polyLatLngs.length; ++j) {
            polyLatLngs[j].lat += end_.lat - start_.lat;
            polyLatLngs[j].lng += end_.lng - start_.lng;
            color[j+1][0] = polyLatLngs[j].lat;
            color[j+1][1] = polyLatLngs[j].lng;
          }

          L.DomUtil.setPosition(svg_, new L.Point(0, 0));
          poly.setLatLngs(polyLatLngs);
          console.log(JSON.stringify(BRIDGEDATA));
        }).bind(this, newPoly, points));
      }
    }

    $('#bridges-layer').css('font-weight', 600);

    var newsources = [BRIDGEDATA];
    if (churchPolys.length > 0) newsources.push(DEMOLISHEDCHURCHDATA);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) });
  }
  else {
    for (var i = 0; i < bridgePolys.length; ++i) {
      map.removeLayer(bridgePolys[i]);
    }

    $('#bridges-layer').css('font-weight', 400);

    var newsources = [DEMOLISHEDCHURCHDATA];
    if (churchPolys.length == 0) newsources.push(BRIDGEDATA,CHURCHDATA,REPURPOSEDCHURCHDATA);
    $('.search').autocomplete({ source: getAutoCompleteNames(newsources) })

    bridgePolys = [];
  }
}

// Firebase auth
var auth = new FirebaseSimpleLogin(fb, fbUserCallback);

function fbUserCallback(error, user) {
  if (error) {
    console.log(error);
    $('#login-text').show();
  }
  else if (user) {
    $('#login-form').hide();
    $('#login-text').show();
    $('#login-text').text("Logged in as " + user.email);
    $('#drawmode').css('display', 'inline');
  }
}

function fbLogin(email, password) {
  auth.login('password', {
    email: email,
    password: password
  }, function(error, user) { 
    if (error)
      console.log(error);
  });
}

function fbSignup(email, password) {

}

// Login form
function showLoginForm(type) {
  var callback;
  if (type == "login") {
    callback = fbLogin;
  }
  else {
    alert("Not working yet. Check back soon!");
    return; //
    callback = fbSignup;
  }

  $('#password').on('keyup', function(e) {
    if (e.keyCode == 13) {
      callback($('#email').val(), $('#password').val());
      $('#password').off('keyup');
    }
  });

  $('#login-form').css('display', 'block');
  $('#login-text').hide();
}

// UTIL

/* GetJSON uses x/y coordinates, whereas
 * Leaflet uses Lat/Lng
 */
function geoJSONToLeaflet(points) {
  var temp;
  for (var i = 0; i < points.length; ++i) {
    temp = points[i][0];
    points[i][0] = points[i][1];
    points[i][1] = temp;
  }

  return points
}
